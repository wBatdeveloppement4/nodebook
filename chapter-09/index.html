<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>DÃ©velopper pour les navigateurs web</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style type="text/css">.interactive--javascript code[data-lang]:before {
  display: block;
  color: #00c72b;
  font-weight: bold;
  cursor: pointer;
}

  [lang="en"] .interactive--javascript code[data-lang]:before {
    content: "â¶ run code";
  }
  [lang="fr"] .interactive--javascript code[data-lang]:before {
    content: "â¶ voir le rÃ©sultat";
  }
  .interactive--javascript code[data-label]:before {
    content: attr(data-label);
  }

.interactive iframe {
  position: absolute;
  visibility: hidden;
}

.interactive.status--loaded iframe {
  position: inherit;
  visibility: visible;
}

.interactive.status--loading {
  opacity: .5;
}
</style><script src="https://embed.runkit.com/" defer async></script><script>(function(){
        function makeListingInteractive(element){
  if (element.classList.contains('interactive--installed')) {
    return;
  }

  const code = element.querySelector('code');
  const source = code
    .textContent
    .replace(/\(\d+\)$/gm, '')
    .replace(/^["']?use strict["'][; ]*\n/, '');

  element.classList.add('status--loading');

  // eslint-disable-next-line no-undef
  RunKit.createNotebook({
    element: element,
    source: source,
    onLoad: function(ntbk) {
      element.classList.add('interactive--installed');
      element.classList.remove('status--loading');
      element.classList.add('status--loaded');
      code.parentNode.setAttribute('hidden', true);

      ntbk.evaluate();
    }
  });
}
function installEvents() {
  function getParent(el, condition) {
    let parent = el;

    while(parent = parent.parentNode) {
      if (condition(parent)) {
        return parent;
      }
    }
  }

  function hasClass(className) {
    return function check(el) {
      return el.classList.contains(className);
    }
  }

  document.querySelector('body').addEventListener('click', function(el) {
    if (el.target.classList.contains('language-javascript')) {
      const parentNode = getParent(
        el.target,
        hasClass('interactive--javascript')
      );

      makeListingInteractive(parentNode);
    }
  });
}

        document.addEventListener('DOMContentLoaded', installEvents);
      })();</script>
<style type="text/css">
.listingblock [data-bash-subs]::before{
  content: attr(data-bash-subs) " ";
  opacity: .5; }
</style>
<style type="text/css">
.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, #toctitle {
  font-style: normal;
  font-weight: bold;
}
a {
  white-space: nowrap;
}
.RemarquePreTitre {
	font-style: normal;
  font-weight: bold;
	border-bottom: 1px solid #ddddd8;
}
.icon .title {
  font-size: 2em;
}
</style>
</head>
<body class="book">
<div id="header">
<h1>DÃ©velopper pour les navigateurs web</h1>
<div class="details">
<span id="revdate">2018-03-06</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>La popularitÃ© de Node s&#8217;est Ã©tablie Ã©galement pour la profusion d&#8217;outillage apportÃ©e au dÃ©veloppement web <em>frontend</em>.</p>
</div>
<div class="paragraph">
<p>Ce chapitre nous apprendra le rÃ´le de Node en tant qu&#8217;extension au dÃ©veloppement <em>frontend</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="ulist">
<div class="title">Sommaire</div>
<ul>
<li>
<p>Polyfills et compatibilitÃ© <em>ECMASCript</em></p>
</li>
<li>
<p>Importer des modules <em>npm</em> pour le web</p>
</li>
<li>
<p>CrÃ©er du code modulaire, avec ou sans <em>framework</em></p>
</li>
<li>
<p>Ãchanges de donnÃ©es en temps-rÃ©el</p>
</li>
<li>
<p>Outillage utile au quotidien</p>
</li>
<li>
<p>Tester son code et la compatibilitÃ© avec les navigateurs web</p>
</li>
</ul>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Avant l&#8217;apparition de Node, rare Ã©tait l&#8217;outillage n&#8217;imposant pas une ou plusieurs plates-formes de dÃ©veloppement : <em>YUICompressor</em> demandait Java, <em>Google Closure Compiler</em> demandait Java, <em>sprockets</em> Ruby et <em>pngquant</em> quelques dÃ©pendances systÃ¨me comme <em>libpng</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;existence de Node et du registre <em>npm</em> a favorisÃ© le dÃ©veloppement d&#8217;un Ã©cosystÃ¨me orientÃ© <em>frontend</em> plus simple Ã  apprÃ©hender.
Cela s&#8217;Ã©tend de la dÃ©couverte au tÃ©lÃ©chargement des librairies tierces ainsi qu&#8217;Ã  la compilation, l&#8217;optimisation et l&#8217;exÃ©cution des tests des applications web cÃ´tÃ© client.</p>
</div>
<div class="paragraph">
<p>Cet <strong>Ã©cosystÃ¨me rend l&#8217;Ã©criture de code moderne normale</strong> ; un code anticipant les futurs standards d'<em>ECMAScript</em> et <em>HTML5</em>, sur les navigateurs actuels et anciens.</p>
</div>
</blockquote>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">ð¬</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Versions de Node et npm</div>
<div class="paragraph">
<p>Le contenu de ce chapitre utilise les versions <strong>Node v8</strong> et <strong>npm v5</strong>.
Ce sont les versions stables en 2018.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Utilisation des exemples</div>
<div class="paragraph">
<p>Les exemples lÃ©gendÃ©s avec un <em>nom de fichier</em> sont disponibles dans le module <em>npm</em> dÃ©diÃ© Ã  cet ouvrage.
Ils sont fonctionnels et destinÃ©s Ã  Ãªtre exÃ©cutÃ©s sur votre ordinateur :</p>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exÃ©cution du bloc de code lÃ©gendÃ© par <code>modules/node-timer.js</code>.</div>
<div class="content">
<pre><span data-bash-subs="$"></span>npm install --global nodebook
<span data-bash-subs="$"></span>nodebook install chapter-09
<span data-bash-subs="$"></span>cd $(nodebook dir chapter-09 --examples)
<span data-bash-subs="$"></span>node modules/node-timer.js</pre>
</div>
</div>
<div class="paragraph">
<p>Certains exemples de ce chapitre correspondent Ã  des pages HTML.
Elles sont destinÃ©es Ã  Ãªtre vues dans un navigateur web
â comme Firefox, Chrome, Edge ou encore Safari.</p>
</div>
<div class="paragraph">
<p>Les exemples sont accessibles en dÃ©marrant le serveur web de la maniÃ¨re suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>cd $(nodebook dir chapter-09)
<span data-bash-subs="$"></span>npm start</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table des matiÃ¨res</div>
<ul class="sectlevel1">
<li><a href="#quel_rapport_entre_node_et_les_navigateurs_web">1. Quel rapport entre Node et les navigateurs web ?</a></li>
<li><a href="#Ã©crire_dÃ¨s_Ã _prÃ©sent_le_code_du_futur">2. Ãcrire dÃ¨s Ã  prÃ©sent le code du futur</a>
<ul class="sectlevel2">
<li><a href="#la_fin_de_l_approche_par_le_dÃ©nominateur_commun">2.1. La fin de l&#8217;approche par le dÃ©nominateur commun</a></li>
<li><a href="#transpilation">2.2. Ãcrire au plus proche des standards</a></li>
<li><a href="#polyfills">2.3. Combler les manques avec des <em>polyfills</em></a></li>
</ul>
</li>
<li><a href="#modules">3. Importer des modules</a>
<ul class="sectlevel2">
<li><a href="#modules-script">3.1. La balise <code>&lt;script&gt;</code></a></li>
<li><a href="#modules-es2015">3.2. Les modules <em>ECMAScript 2015</em></a></li>
<li><a href="#browserify">3.3. Importer des modules <em>npm</em> pour le web</a></li>
<li><a href="#rÃ©capitulatif">3.4. RÃ©capitulatif</a></li>
</ul>
</li>
<li><a href="#conception_modulaire">4. Conception modulaire</a>
<ul class="sectlevel2">
<li><a href="#le_syndrome_du_plugin_em_jquery_em">4.1. Le syndrome du plugin <em>jQuery</em></a></li>
<li><a href="#vers_une_approche_em_jquery_em_composite">4.2. Vers une approche <em>jQuery</em> composite</a></li>
<li><a href="#partager_le_code_mÃ©tier_avec_node">4.3. Partager le code mÃ©tier avec Node</a></li>
<li><a href="#sÃ©paration_du_fond_et_de_la_forme_donnÃ©es_rendu_et_interactions">4.4. SÃ©paration du fond et de la forme : donnÃ©es, rendu et interactions</a></li>
<li><a href="#react">4.5. Rapprocher donnÃ©es, rendu et interactions avec <em>React</em></a></li>
</ul>
</li>
<li><a href="#io">5. Des requÃªtes AJAX au temps-rÃ©el</a>
<ul class="sectlevel2">
<li><a href="#io-fetch">5.1. Ãchange ponctuel de donnÃ©es avec <code>fetch()</code></a></li>
<li><a href="#io-eventsource">5.2. Approche unidirectionnelle avec <em>EventSource</em></a></li>
<li><a href="#io-websocket">5.3. Ãchanges en temps-rÃ©el avec <em>WebSocket</em></a></li>
</ul>
</li>
<li><a href="#dÃ©velopper_au_quotidien">6. DÃ©velopper au quotidien</a>
<ul class="sectlevel2">
<li><a href="#watchify">6.1. Reconstruire en continu avec <code>watchify</code></a></li>
<li><a href="#livereload">6.2. Changements en temps-rÃ©el dans le navigateur</a></li>
<li><a href="#node-sass">6.3. Modulariser ses feuilles de style avec <em>Sass</em></a></li>
<li><a href="#ui-bundling">6.4. Lier composants visuels et feuilles de style</a></li>
<li><a href="#optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</a></li>
</ul>
</li>
<li><a href="#testing">7. Tester son code</a>
<ul class="sectlevel2">
<li><a href="#testing-101">7.1. Que tester ?</a></li>
<li><a href="#s_outiller_pour_Ã©crire_des_assertions">7.2. S&#8217;outiller pour Ã©crire des assertions</a></li>
<li><a href="#tester_ses_composants_react_sans_navigateur_web">7.3. Tester ses composants React sans navigateur web</a></li>
<li><a href="#tester_code_et_composants_dans_les_navigateurs_web">7.4. Tester code et composants dans les navigateurs web</a></li>
<li><a href="#ci">7.5. IntÃ©gration continue et compatibilitÃ© navigateurs</a></li>
</ul>
</li>
<li><a href="#conclusion">8. Conclusion</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quel_rapport_entre_node_et_les_navigateurs_web">1. Quel rapport entre Node et les navigateurs web ?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce chapitre peut sembler confus au premier abord.
Si Node s&#8217;exÃ©cute au niveau du systÃ¨me d&#8217;exploitation â "cÃ´tÃ© serveur" â en quoi est-il liÃ© au dÃ©veloppement <em>frontend</em> â "cÃ´tÃ© client" ?
Est-ce parce que du code Ã©crit pour Node peut aussi fonctionner dans un navigateur web ?
<em>Quid</em> de l&#8217;utilisation de <code>require('fs')</code> pour accÃ©der au systÃ¨me de fichiers ?</p>
</div>
<div class="paragraph">
<p>La rÃ©ponse <em>courte</em> est : <strong>nous n&#8217;exÃ©cutons pas Node dans un navigateur web</strong>.</p>
</div>
<div class="paragraph">
<p>Et la rÃ©ponse <em>longue</em> : <strong>Node est utilisÃ© pour assembler du code</strong>, le <em>transformer</em> et le rendre fonctionnel dans une paire de balises <code>&lt;script&gt;&lt;/script&gt;</code>.<br>
Ce code peut Ãªtre aussi bien fourni par des <strong>librairies tierces</strong> installÃ©es via <em>npm</em> (<em>jQuery</em>, <em>React</em> ou <em>d3</em> par exemple) que par de l'<strong>outillage</strong> (optimiseurs, suite de tests, orchestration de tÃ¢ches, etc.) ou encore par le <strong>code rÃ©utilisable</strong> de notre propre application web.</p>
</div>
<div class="paragraph">
<p>Il faut Ã©galement bien comprendre qu&#8217;il y a plusieurs "problÃ¨mes" cachÃ©s sous une mÃªme question :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les navigateurs web et Node utilisent diffÃ©rentes machines virtuelles JavaScript, avec diffÃ©rents niveaux de complÃ©tion dans l&#8217;implÃ©mentation d'<em>ECMAScript</em> ;</p>
</li>
<li>
<p>Les navigateurs web et Node n&#8217;ont pas accÃ¨s aux mÃªmes APIs â Node accÃ¨de Ã  <code>fs</code> et <code>http</code> tandis que les navigateurs ont <code>File</code> et <code>fetch</code>/<code>XmlHttpRequest</code> ;</p>
</li>
<li>
<p>Les navigateurs web et Node ne gÃ¨rent pas le chargement de modules de la mÃªme maniÃ¨re â voir la section <a href="#managing-dependencies">gestion des dÃ©pendances</a> ;</p>
</li>
<li>
<p>L&#8217;implÃ©mentation mÃªme d'<em>ECMAScript</em> va diffÃ©rer selon les versions de Node employÃ©es â un navigateur moderne et Node 6 comprendraient l&#8217;objet natif <code>Promise</code> mais pas Node 0.12.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce processus n&#8217;est <em>pas magique</em> et nous verrons graduellement au cours des prochaines sections comment tout ceci fonctionne.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Ã©crire_dÃ¨s_Ã _prÃ©sent_le_code_du_futur">2. Ãcrire dÃ¨s Ã  prÃ©sent le code du futur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transformer du code ECMAScript a pendant longtemps Ã©tÃ© chose pÃ©nible.
Je pense par exemple Ã  de la minification de code (pour rÃ©duire les temps de transfert sur les antiques lignes ADSL 128K) ou Ã  de la conversion automatique de code <em>ECMAScript 3</em> en <em>ECMAScript 5</em>.
Cela nÃ©cessitait systÃ©matiquement l&#8217;utilisation d&#8217;un autre environnement qu&#8217;ECMAScript lui-mÃªme: <em>Rhino</em> nÃ©cessitait Java, <em>Spidermonkey</em> nÃ©cessitait C++ et <em>Trident</em> nÃ©cessitait un environnement Windows en plus de C++.</p>
</div>
<div class="paragraph">
<p><strong>esprima</strong> chamboule les rÃ¨gles du jeu en dÃ©cembre 2011 : ce parseur <em>ECMAScript</em> â lui-mÃªme Ã©crit en <em>ECMAScript</em> â exporte une comprÃ©hension de code sous forme d&#8217;arbre syntaxique abstrait (<em>abstract syntax tree</em>, <em>AST</em>).
Cet arbre est lui-mÃªme analysable par de <strong>nouveaux outils Ã©mergents</strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les <em>source maps</em> pour associer le code transformÃ© au code d&#8217;origine, notamment dans les outils de dÃ©veloppement des navigateurs web ;</p>
</li>
<li>
<p>des <em>minifieurs</em> plus efficaces et ayant connaissance des portions de code exÃ©cutÃ©es ;</p>
</li>
<li>
<p>des <em>analyseurs de code</em> pour informer le dÃ©veloppeur d&#8217;erreurs de syntaxe, de non-respect de styles de dÃ©veloppement, etc. ;</p>
</li>
<li>
<p>des <em>convertisseurs de code</em> pour passer d'<em>ECMAScript</em> vers <em>CoffeeScript</em>, de modules <em>CommonJS</em> vers des modules <em>ECMAScript 2015</em>, etc.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Annonce d'<em>esprima</em></div>
<div class="paragraph">
<p><em>Aryia Hidayat</em> introduit esprima dans un billet de blog.
Il y prÃ©sente notamment des comparatifs de performances d&#8217;exÃ©cution sur diffÃ©rentes VM ECMAScript et face Ã  d&#8217;autres parseurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://ariya.io/2011/12/introducing-esprima" class="bare">ariya.io/2011/12/introducing-esprima</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="la_fin_de_l_approche_par_le_dÃ©nominateur_commun">2.1. La fin de l&#8217;approche par le dÃ©nominateur commun</h3>
<div class="paragraph">
<p>Qui n&#8217;a pas dÃ©jÃ  entamÃ© un projet en posant la question Ã  un client, en regardant les statistiques de traffic ou en se posant une question Ã  soi-mÃªme : quelle est la liste des versions de navigateurs avec lequel notre site ou application web doit Ãªtre compatible ?</p>
</div>
<div class="paragraph">
<p>La version de navigateur la plus ancienne ou la moins conforme aux standards Ã©tait celle qui donnait le <em>la</em> (qui a prononcÃ© <em>Internet Explorer 7</em> dans la salle ?).<br>
Cela voulait dire se priver de techniques modernes, standardisÃ©es ou en cours de standardisation.
Cela voulait dire des <em>hacks</em> dans ses CSS, dans son code <em>ECMAScript</em> et dans ses ressources graphiques.</p>
</div>
</div>
<div class="sect2">
<h3 id="transpilation">2.2. Ãcrire au plus proche des standards</h3>
<div class="paragraph">
<p>Fort heureusement l&#8217;arrivÃ©e d'<em>esprima</em> change la donne et permet d&#8217;Ã©crire un code proche des standards qui rÃ©siste au temps.
Son existence facilite l'<strong>Ã©mergence d&#8217;outils automatisant les transformations de code</strong> pour satisfaire nos besoins spÃ©cifiques.</p>
</div>
<div class="paragraph">
<p>Il y a plusieurs Ã©lÃ©ments Ã  prendre en compte concernant la standardisation de nouvelles versions d'<em>ECMAScript</em> et les Ã©volutions de sa syntaxe :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>la <strong>cadence de standardisation</strong> a Ã©tÃ© revue pour devenir prÃ©dictible â une volontÃ© d&#8217;une fois par an ;</p>
</li>
<li>
<p>les <strong>fonctionnalitÃ©s et Ã©lÃ©ments de syntaxe sont implÃ©mentÃ©s un par un</strong>, Ã  des vitesses diffÃ©rentes par les diffÃ©rents navigateurs web ;</p>
</li>
<li>
<p><em>deux tiers</em> de navigateurs fonctionnent sur des <strong>rythmes de mises Ã  jour en cycle court</strong> (de six Ã  neuf semaines) â le <em>tiers</em> restant est cadencÃ© Ã  <strong>une seule mise Ã  jour par an</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il vaut mieux <strong>parier sur les standards comme stratÃ©gie Ã  long terme</strong> si on tient compte du <em>temps de dÃ©veloppement</em> et du <em>temps de maintenance</em> d&#8217;une base de code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Question</span> Standards, quels standards ?</div>
<div class="paragraph">
<p>Il y a plusieurs organismes prenant part Ã  la standardisation de langages et d&#8217;API lorsque l&#8217;on touche aux navigateurs web :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pour le <em>langage HTML</em> : WHATWG (<span class="URL"><a href="https://html.spec.whatwg.org/" class="bare">html.spec.whatwg.org/</a></span>) ;</p>
</li>
<li>
<p>Pour l'<em>API DOM</em> : WHATWG (<span class="URL"><a href="https://dom.spec.whatwg.org/" class="bare">dom.spec.whatwg.org/</a></span>) ;</p>
</li>
<li>
<p>Pour le <em>langage CSS</em> : W3C (<span class="URL"><a href="https://www.w3.org/standards/techs/css" class="bare">www.w3.org/standards/techs/css</a></span>) ;</p>
</li>
<li>
<p>Pour le <em>langage ECMAScript</em> : TC39 (<span class="URL"><a href="https://github.com/tc39" class="bare">github.com/tc39</a></span>) ;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lorsque nous Ã©crivons du code, nous pouvons rencontrer quatre cas de figure :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ã©lÃ©ment de syntaxe non-implÃ©mentÃ©</strong> : transformer le code pour l&#8217;adapter aux navigateurs cibles ;</p>
</li>
<li>
<p><strong>Ã©lÃ©ment de syntaxe partiellement implÃ©mentÃ©</strong> : utiliser l&#8217;implÃ©mentation native des navigateurs et Ã  dÃ©faut, transformer le code pour l&#8217;adapter aux autres navigateurs ;</p>
</li>
<li>
<p><strong>Ã©lÃ©ment de syntaxe totalement implÃ©mentÃ©</strong> : utiliser l&#8217;implÃ©mentation native des navigateurs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il arrive que certains Ã©lÃ©ments de syntaxe soient <strong>abandonnÃ©s</strong> pendant le processus de standardisation â ou que leur implÃ©mentation change beaucoup (on pensera Ã  <code>Object.observe</code>).</p>
</div>
<div class="paragraph">
<p>La question qui nous taraude est : <strong>comment transformer le code</strong> pour satisfaire Ã  la fois les navigateurs compatibles et les autres ?<br>
<strong>Babel</strong> est un outil de choix  pour parvenir Ã  ces fins d&#8217;Ã©criture de code rÃ©sistant au(x standards du) temps.</p>
</div>
<div class="paragraph">
<p>Ce module convertit de maniÃ¨re sÃ©lective toute syntaxe <em>ECMAScript 2015</em> â ainsi que <em>ECMAScript 2016</em>, etc. â vers de l'<em>ECMAScript 5</em>, comprÃ©hensible par les <em>navigateurs web modernes</em>.
L&#8217;intÃ©rÃªt de sa <em>sÃ©lectivitÃ©</em> fait que l&#8217;on peut progressivement arrÃªter de convertir les Ã©lÃ©ments de syntaxe couverts par 100% des navigateurs web modernes.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Histoire</span> Traceur</div>
<div class="paragraph">
<p><em>Traceur</em> est un des premiers transpilateurs <em>ECMAScript 2015</em> vers <em>ECMAScript 5</em> Ã  avoir Ã©mergÃ© dans l&#8217;Ã©cosystÃ¨me Node.</p>
</div>
<div class="paragraph">
<p>Il a permis de commencer Ã  <strong>Ã©crire des modules en <em>ECMAScript 2015</em> bien avant que la spÃ©cification ne soit entiÃ¨rement terminÃ©e</strong>.
Et donc de pouvoir anticiper son apprentissage tout en mettant le langage Ã  l&#8217;Ã©preuve avant sa finalisation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre un code utilisant des Ã©lÃ©ments de syntaxe d'<em>ECMAScript 2015</em>.</p>
</div>
<div class="listingblock">
<div class="title">babel-es2015.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const getOS = userAgent =&gt; {
  const [, os, version] = userAgent.match(/\(([^;]+)\s?;\s?([^)]+)\)/);
  return {os, version};
};

const {userAgent} = window.navigator; <b class="conum">(1)</b>

console.log(getOS(userAgent)); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous dÃ©structurons l'<em>agent utilisateur</em> du navigateur â Ã  noter que ce mÃªme code exÃ©cutÃ© par Node lancerait une exception car <code>window</code> n&#8217;existe pas dans cet environnement ;</p>
</li>
<li>
<p>Affiche un objet content le <em>nom</em> de votre systÃ¨me d&#8217;exploitation ainsi que sa <em>version</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ce code reprÃ©sente l'<strong>idÃ©al de ce que l&#8217;on souhaite Ã©crire</strong>.
Le seul obstacle consiste Ã  <em>traduire</em> ce code pour l&#8217;ensemble des navigateurs web compatibles avec <em>ECMAScript 5</em>.</p>
</div>
<div class="paragraph">
<p>ExÃ©cutons cette commande :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run babel -- --no-babelrc examples/babel-es2015.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie affichÃ©e correspond <em>exactement</em> Ã  notre code d&#8217;origine.
C&#8217;est parce que sans configuration, <em>babel</em> ne transforme rien.<br>
L&#8217;ouvrage contient un fichier de configuration <code>.babelrc</code>.
Nous expliquerons son contenu aprÃ¨s en avoir observÃ© son impact :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run babel -- examples/babel-es2015.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie a changÃ© et renvoie un code totalement fonctionnel sur des navigateurs web ne supportant pas <em>ECMAScript 2015</em> :</p>
</div>
<div class="listingblock">
<div class="title">babel-es2015ified.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var getOS = function getOS(userAgent) {
  var _userAgent$match = userAgent.match(/\(([^;]+)\s?;\s?([^)]+)\)/),
      os = _userAgent$match[1],
      version = _userAgent$match[2];

  return { os: os, version: version };
};

var userAgent = window.navigator.userAgent;


console.log(getOS(userAgent));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il existe de nombreuses rÃ¨gles de transformation.
Chacune d&#8217;entre elles cible une fonctionnalitÃ© spÃ©cifique d&#8217;une version d'<em>ECMAScript</em>.
Les <strong><em>presets</em> des modules <em>npm</em> faisant office de groupes logiques</strong>.</p>
</div>
<div class="paragraph">
<p>Les <em>presets</em> suivants nous aideront Ã  convertir chaque Ã©dition de spÃ©cification <em>ECMAScript</em> vers <em>ECMASCript 5</em>.
Le <strong>dernier <em>preset</em> est le plus simple Ã  utiliser</strong>, car il se base sur les parts de marchÃ© des navigateurs web pour dÃ©terminer les rÃ¨gles de conversion :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>preset-es2015</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2015/" class="bare">babeljs.io/docs/plugins/preset-es2015/</a></span>) ;</p>
</li>
<li>
<p><code>preset-es2016</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2016/" class="bare">babeljs.io/docs/plugins/preset-es2016/</a></span>) ;</p>
</li>
<li>
<p><code>preset-es2017</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-es2017/" class="bare">babeljs.io/docs/plugins/preset-es2017/</a></span>) ;</p>
</li>
<li>
<p><code>preset-latest</code> (<span class="URL"><a href="https://babeljs.io/docs/plugins/preset-latest/" class="bare">babeljs.io/docs/plugins/preset-latest/</a></span>) ;</p>
</li>
<li>
<p><code>preset-env</code> (<span class="URL"><a href="https://npmjs.com/babel-preset-env" class="bare">npmjs.com/babel-preset-env</a></span>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ils sont Ã  placer dans un fichier de configuration nommÃ© <code>.babelrc</code>.
L&#8217;exemple suivant illustre la <em>combinaison</em> de deux <em>presets</em> pour convertir la syntaxe <em>ECMAScript 2015</em> et <em>ECMAScript 2016</em> vers <em>ECMAScript 5</em> :</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre>{
  "presets": [
    "es2015",
    "es2016"
  ]
}</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lien</span> Documentation de <em>babel</em></div>
<div class="paragraph">
<p>Toutes les options de configuration sont documentÃ©es sur le site officiel de <em>babel</em>.
Une autre page explique oÃ¹ placer et quoi mettre dans les fichiers <code>.babelrc</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://babeljs.io/docs/usage/api/#options" class="bare">babeljs.io/docs/usage/api/#options</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://babeljs.io/docs/usage/babelrc/" class="bare">babeljs.io/docs/usage/babelrc/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="polyfills">2.3. Combler les manques avec des <em>polyfills</em></h3>
<div class="paragraph">
<p>Des outils comme <em>babel</em> nous permettent d&#8217;Ã©crire avec une <strong>syntaxe moderne</strong>.
Les <strong>polyfills</strong> sont des bouts de code qui nous permettent de <strong>combler les fonctionnalitÃ©s manquantes</strong> â leur implÃ©mentation.</p>
</div>
<div class="paragraph">
<p>Un <strong>polyfill harmonise la prÃ©sence d&#8217;une fonctionnalitÃ©</strong> au sein d&#8217;une variÃ©tÃ© de navigateurs web et d&#8217;environnements JavaScript.
Cela se fera au dÃ©triment de <strong>quelques kilo-octets de code</strong> Ã  charger en plus dans nos applications.
L&#8217;appel Ã  un service de polyfill externe entrainera un <strong>lÃ©ger ralentissement du chargement</strong> de notre page.</p>
</div>
<div class="paragraph">
<p>Prenons le bloc de code suivant :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">'use strict';

Promise.resolve('ok');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprenons que :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cette <strong>syntaxe est valide</strong> dans toutes les versions d'<em>ECMAScript</em> (<em>babel</em> ne changera rien Ã  ce code) ;</p>
</li>
<li>
<p>l&#8217;objet global <code>Promise</code> existe dans un navigateur moderne ;</p>
</li>
<li>
<p>l&#8217;objet global <code>Promise</code> n&#8217;existe pas dans <em>Internet Explorer 11</em>, entre autres.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce code fonctionnerait donc sur un navigateur moderne mais pas dans <em>IE11</em>.
L&#8217;inclusion d&#8217;un <em>polyfill</em> de <code>Promise</code> rÃ©soudrait le problÃ¨me.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Bonne pratique</span> Quand inclure les <em>polyfills</em> ?</div>
<div class="paragraph">
<p><strong>Un polyfill se charge toujours en premier</strong>.
On incluera tous les polyfills d&#8217;un coup <strong>avant notre propre code</strong>.</p>
</div>
<div class="paragraph">
<p>Nous garantissons ainsi une <strong>cohÃ©rence et stabilitÃ© de comportement</strong> au sein de notre application, peu importe l&#8217;ordre d&#8217;exÃ©cution de nos scripts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Parlons maintenant des mÃ©thodes d&#8217;inclusion des <em>polyfills</em> pour mieux comprendre comment procÃ©der.</p>
</div>
<div class="paragraph">
<p>Le <strong>service polyfill.io</strong> est de loin la mÃ©thode la plus simple Ã  utiliser.
Il suffit d&#8217;inclure un script dans toutes vos pages web.
<em>polyfill.io</em> dÃ©terminera les <em>polyfills</em> Ã  charger en fonction de la compatibilitÃ© du navigateur chargeant la page :</p>
</div>
<div class="listingblock">
<div class="title">polyfill.io.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Example polyfill.io&lt;/title&gt;
    &lt;script src="https://cdn.polyfill.io/v2/polyfill.min.js"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script&gt;
      Promise.resolve('ok')
        .then(msg =&gt; console.log(msg));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> polyfill.io</div>
<div class="paragraph">
<p><em>polyfill.io</em> possÃ¨de une documentation trÃ¨s complÃ¨te.
Elle nous aidera Ã  configurer finement le service en fonction de nos besoins.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://qa.polyfill.io/v2/docs/" class="bare">qa.polyfill.io/v2/docs/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous pouvons dÃ©duire <strong>deux rÃ¨gles</strong> de l&#8217;exemple prÃ©cÃ©dent :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>inclure les <em>polyfills</em> en <strong>tout premier</strong> ;</p>
</li>
<li>
<p>inclure les <em>polyfills</em> <strong>en dehors</strong> de notre code.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La deuxiÃ¨me mÃ©thode est d'<strong>embarquer les polyfills</strong> dans notre base de code.
L&#8217;avantage est de maitriser notre base de code et de ne pas dÃ©pendre d&#8217;un service externe.
L&#8217;inconvÃ©nient est que nous chargeons du code qui sera inutile dans les navigateurs et environnements disposant dÃ©jÃ  de ces fonctionnalitÃ©s :</p>
</div>
<div class="listingblock">
<div class="title">polyfill-import.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Exemple polyfill custom&lt;/title&gt;
    &lt;script type="module"&gt;
      import 'es6-promise/auto';        <b class="conum">(1)</b>
      import 'core-js/fn/number/is-nan';<b class="conum">(2)</b>
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script&gt;
      Promise.resolve(Number.isNaN(NaN))
        .then(msg =&gt; console.log(msg));
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous verrons <a href="#modules">comment importer des modules</a> ci-aprÃ¨s ;</p>
</li>
<li>
<p>On importe un deuxiÃ¨me <em>polyfill</em>, celui de la mÃ©thode <code>Number.isNaN</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le module <em>npm</em> <code>core-js</code> est une librairie exhaustive de <em>polyfills</em> pouvant Ãªtre inclus un Ã  un ou par versions d'<em>ECMAScript</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <code>core-js</code></div>
<div class="paragraph">
<p>La documentation en ligne de <code>core-js</code> liste l&#8217;ensemble des <em>polyfills</em> supportÃ©s par ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/core-js" class="bare">npmjs.com/core-js</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>babel</em> et son <em>preset</em> <code>babel-preset-env</code> nous facilitent l&#8217;inclusion de <em>polyfills</em> selon la compatibilitÃ© navigateurs que l&#8217;on souhaite maintenir au sein de notre application. Le fichier <code>.babelrc</code> suivant configure l&#8217;inclusion des <em>polyfills</em> Ã  l&#8217;aide des clÃ©s <code>useBuiltIns</code> et <code>targets</code> :</p>
</div>
<div class="listingblock">
<div class="title">.babelrc</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "comments": false,
  "presets": [
    "react",
    [
      "env", {
        "loose": true,
        "useBuiltIns": true,
        "targets": {
          "ie": 9,
          "browsers": [
            "&gt; 5%"
          ]
        }
      }
    ]
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette configuration illustre un souhait de compatibilitÃ© avec <em>Internet Explorer 9</em> et les navigateurs web disposant d&#8217;une part de marchÃ© supÃ©rieure Ã  5%.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">â ï¸</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Attention</span> Performance et duplication</div>
<div class="paragraph">
<p>Il faut veiller Ã  ne pas alourdir inutilement une application.</p>
</div>
<div class="paragraph">
<p>Laissons la responsabilitÃ© de <em>polyfiller</em> aux utilisateurs de notre code ; particuliÃ¨rement si celui-ci est <strong>redistribuÃ©</strong> en tant que module <em>npm</em> public.</p>
</div>
<div class="paragraph">
<p>Si plusieurs scripts nÃ©cessitent des polyfills, mieux vaut inclure ces derniers <em>en une fois</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script src="polyfills.js"&gt;&lt;/script&gt;
&lt;script src="script-a.js"&gt;&lt;/script&gt;
&lt;script src="script-b.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enfin, une derniÃ¨re mÃ©thode est d'<strong>importer la fonction de <em>polyfill</em> sans rÃ©Ã©crire les objets globaux</strong>.
Cette pratique a l&#8217;avantage de <em>ne pas entrainer d&#8217;effets secondaires</em> et de garantir le <em>mÃªme comportement</em> dans tous les navigateurs web.
L&#8217;inconvÃ©nient est qu&#8217;on n&#8217;utilise pas la fonctionnalitÃ© native des navigateurs lorsqu&#8217;elle est prÃ©sente.
Nous nous retrouvons tributaires de la qualitÃ© d&#8217;implÃ©mentation du <em>polyfill</em>.</p>
</div>
<div class="listingblock">
<div class="title">polyfill-require.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import {Promise as PromisePolyfill} from 'es6-promise';

PromisePolyfill.resolve('ok').then(msg =&gt; console.log(msg));

console.log('Promise' in window);                <b class="conum">(1)</b>
console.log(PromisePolyfill === window.Promise); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>true</code> si le navigateur implÃ©mente l&#8217;API <em>Promise</em> â sinon affiche <code>false</code> et l&#8217;utilisation d&#8217;un <em>polyfill</em> prend tout son sens ;</p>
</li>
<li>
<p>Affiche <code>false</code>, car le <em>polyfill</em> de <em>Promise</em> est une function strictement diffÃ©rente de <code>window.Promise</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Bonnes pratiques constatÃ©es</div>
<div class="paragraph">
<p>De bons usages des <em>polyfills</em> ainsi les risques liÃ©s Ã  leur utilisation sont compilÃ©s dans un guide Ã©ditÃ© par le W3C.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://w3ctag.github.io/polyfills/" class="bare">w3ctag.github.io/polyfills/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="modules">3. Importer des modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Importer des modules est une pratique courante avec Node.
Ãa l&#8217;est en revanche beaucoup moins dans l&#8217;univers du web puisqu&#8217;il n&#8217;existait rien de <em>natif</em> avant les <a href="#modules-es2015">modules ECMAScript 2015</a>.</p>
</div>
<div class="paragraph">
<p>Auparavant, on aura vu dÃ©barquer les modules <em>AMD</em> (<em>Asynchronous Module Definition</em>) pour gÃ©rer les dÃ©pendances <em>entre scripts</em>.
Les librairies <em>Dojo</em>, <em>RequireJS</em> et <em>YUI</em> ont popularisÃ© ce motif de conception.
Un dÃ©sir d&#8217;universalitÃ© a ensuite Ã©mergÃ© avec le gain de popularitÃ© croissant de Node avec les modules <em>UMD</em>, conciliant modules <em>AMD</em> et <em>CommonJS</em>.</p>
</div>
<div class="paragraph">
<p>Les modules <em>ECMAScript 2015</em> ont Ã©mergÃ© de ce bouillonnement.</p>
</div>
<div class="sect2">
<h3 id="modules-script">3.1. La balise <code>&lt;script&gt;</code></h3>
<div class="paragraph">
<p>Rappelons-le, la mÃ©thode incontournable pour charger du code dans un navigateur web est l&#8217;utilisation de la base <code>&lt;script&gt;</code>.
Le chargement puis l&#8217;Ã©valuation et l&#8217;exÃ©cution du script bloque le temps nÃ©cessaire le rendu d&#8217;un document HTML.</p>
</div>
<div class="listingblock">
<div class="title">import/script.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script src="global-dom-log.js"&gt;&lt;/script&gt;
&lt;script src="script.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les diffÃ©rents <em>scripts</em> partagent le mÃªme espace mÃ©moire, permettant ainsi Ã  <code>script.js</code> d&#8217;avoir accÃ¨s Ã  la fonction <code>log</code> dÃ©finie dans <code>global-dom-log.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">import/global-dom-log.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// eslint-disable-next-line no-unused-vars
const log = (message) =&gt; {
  document.querySelector('#logs').textContent = String(message).trim();
};</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">import/script.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">/* global log */
window.addEventListener('load', () =&gt; {
  log('OK');<b class="conum">(2)</b>
});

log('KO');  <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche une erreur car <code>&lt;div id="logs"&gt;</code> n&#8217;existe pas encore dans le document Ã  ce stade de l&#8217;exÃ©cution ;</p>
</li>
<li>
<p>Cette ligne est exÃ©cutÃ©e une fois le document chargÃ© â <code>&lt;div id="logs"&gt;</code> contient dÃ©sormais le texte <code>OK</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>S&#8217;il est facile d&#8217;ajouter du code dans le navigateur, on constate plusieurs problÃ¨mes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>partager du code entre scripts repose sur une <strong>attente explicite</strong> ;</p>
</li>
<li>
<p>le partage de variables entre scripts peut entrainer des <strong>collisions</strong> (par exemple, deux variables du mÃªme nom dÃ©finies dans des scripts diffÃ©rents) ;</p>
</li>
<li>
<p>il n&#8217;y a pas de moyen Ã©vident de rendre des bouts de code <em>privÃ©</em> au sein de chaque script.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le dÃ©veloppement frontend basÃ© sur de l&#8217;outillage Node va justement nous aider Ã  <strong>solidifier et renforcer la rÃ©utilisabilitÃ© de notre code</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="modules-es2015">3.2. Les modules <em>ECMAScript 2015</em></h3>
<div class="paragraph">
<p>Nous avons Ã©voquÃ© les <a href="../chapter-03/index.html#primitives">primitives <em>ECMAScript 2015</em></a> dans le Chapitre 3.
Les modules font partie des fonctionnalitÃ©s tant attendues.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/module-import.png" alt="module import" width="85%">
</div>
<div class="title">Figure 1. Utilisation des modules <em>ECMAScript 2015</em> dans un navigateur web (ici, Safari pour macOS).</div>
</div>
<div class="paragraph">
<p>L&#8217;attribut <code>type="module"</code> a Ã©tÃ© introduit pour maintenir une compatibilitÃ© entre scripts classiques et les modules <em>ECMAScript 2015</em>.
Ce mÃ©canisme de modules introduit plusieurs concepts importants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>toute variable est privÃ©e</strong> sauf si elle est <em>exportÃ©e</em> avec l&#8217;opÃ©rateur <code>export</code> ;</p>
</li>
<li>
<p>les <strong>modules sont explicitement inclus</strong> avec l&#8217;opÃ©rateur <code>import</code> ;</p>
</li>
<li>
<p>les <strong>variables globales</strong> dÃ©finies par l&#8217;utilisateur ne sont pas accessibles depuis un module.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Retravaillons le document HTML de la section prÃ©cÃ©dente :</p>
</div>
<div class="listingblock">
<div class="title">import/import.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script&gt;const pro = 'test';&lt;/script&gt;
&lt;script type="module" src="script-import.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nous voulons maintenant (sa)voir si la variable <code>pro</code> dÃ©finie avant l&#8217;inclusion du module <code>script-import.js</code> est constatÃ©e.
Nous voulons Ã©galement savoir si la syntaxe d&#8217;import de la fonction <code>log</code> fonctionne :</p>
</div>
<div class="listingblock">
<div class="title">import/script-import.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import {log} from './dom-log.js';

console.log(typeof pro);    <b class="conum">(1)</b>
console.log(typeof log);    <b class="conum">(2)</b>
console.log(typeof window); <b class="conum">(3)</b>

window.addEventListener('load', () =&gt; {
  log('OK');
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Affiche <code>undefined</code> ;</p>
</li>
<li>
<p>Affiche <code>function</code> ;</p>
</li>
<li>
<p>Affiche <code>object</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>De mÃªme que nous avons utilisÃ© <code>import</code> pour importer de maniÃ¨re sÃ©lective une fonction du module <code>dom-log.js</code>, l&#8217;opÃ©rateur <code>export</code> nous aide Ã  exposer des objets, fonctions et variables :</p>
</div>
<div class="listingblock">
<div class="title">import/dom-log.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">export function log (message, target = '#logs') {
  document.querySelector(target).textContent = String(message).trim();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="browserify">3.3. Importer des modules <em>npm</em> pour le web</h3>
<div class="paragraph">
<p>Qu&#8217;en est-il alors des modules <em>npm</em> ?
Nous pouvons transpiler et importer du code, ce serait trÃ¨s utile si nous pouvions Ã©galement importer du <em>code tiers</em>.
Cela nous Ã©viterait de rÃ©inventer la roue, d&#8217;avoir accÃ¨s Ã  du code bien testÃ© et trop coÃ»teux Ã  Ã©crire nous-mÃªmes.</p>
</div>
<div class="paragraph">
<p>Nous avons vu comment <a href="../chapter-04/index.html#api-require">charger des modules <em>npm</em></a> dans le Chapitre 4.
Si seulement nous pouvions faire la mÃªme chose cÃ´tÃ© clientâ¦<br>
Continuons sur la lancÃ©e de nos exemples prÃ©cÃ©dents pour tenter d&#8217;inclure la librairie <em>jQuery</em> afin de manipuler notre document HTML :</p>
</div>
<div class="listingblock">
<div class="title">import/script-import-jquery.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import $ from 'jquery';

console.log($.fn.jquery);  <b class="conum">(1)</b>

$(document).ready(() =&gt; {
  $('#logs').text('OK');   <b class="conum">(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>$.fn.jquery</code> contient le numÃ©ro de version de jQuery ;</p>
</li>
<li>
<p>Substitut jQuery pour remplacer le texte dans <code>&lt;div id="logs"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le document HTML chargeant ce module est en tout point similaire au prÃ©cÃ©dent exemple :</p>
</div>
<div class="listingblock">
<div class="title">import/import-jquery.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script type="module" src="script-import-jquery.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le seul <em>hic</em>, c&#8217;est que <strong>cela ne fonctionne pas</strong> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le navigateur <em>ne peut pas savoir</em> oÃ¹ se trouve la dÃ©pendance demandÃ©e ;</p>
</li>
<li>
<p>rien ne garantit que <code>jquery</code> expose son code en tant que module <em>ECMAScript 2015</em> ;</p>
</li>
<li>
<p>on n&#8217;a certainement pas envie d&#8217;exposer publiquement le rÃ©pertoire <code>node_modules</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>C&#8217;est alors qu&#8217;entre en jeu <strong>browserify</strong>.
<em>browserify</em> est un outil gÃ©nÃ©rique de transformation de code.
Il peut Ãªtre utilisÃ© en ligne de commande, via son API Node mais aussi par le biais de plugins pour d&#8217;autres outils (comme Gulp, Grunt, etc.).</p>
</div>
<div class="paragraph">
<p><em>browserify</em> a Ã©tÃ© initialement crÃ©Ã© pour transformer du code Ã©crit pour Node en code fonctionnel dans les navigateurs web.
Il expose notamment un concept d&#8217;intÃ©grations (les <em>transforms</em>) afin d&#8217;effectuer des remplacements ligne Ã  ligne.</p>
</div>
<div class="paragraph">
<p>LÃ  oÃ¹ <em>babel</em> cherche uniquement Ã  traduire un langage vers un autre, <em>browserify</em> est le couteau suisse pour effectuer des remplacements majeurs dans le code :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>portage de la fonction <code>require()</code> et inclusion du code des modules sous-jacents ;</p>
</li>
<li>
<p>suppression de code conditionnel ;</p>
</li>
<li>
<p>remplacement d&#8217;API spÃ©cifiques Ã  Node par des polyfills pour le web ;</p>
</li>
<li>
<p>extraction de CSS ;</p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>browserify</em> est intÃ©ressant au sens oÃ¹ il nous apprend Ã  nous constituer nous-mÃªmes notre outillage, pour nos propres besoins.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Utiliser browserify</div>
<div class="paragraph">
<p><em>browserify</em> est un outil extrÃªmement versatile, modulaire et puissant.
Son apprentissage progressif peut faire de lui un alliÃ© de choix dans tous vos projets Node et web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/browserify" class="bare">npmjs.com/browserify</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://github.com/substack/browserify-handbook" class="bare">github.com/substack/browserify-handbook</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Revenons maintenant Ã  notre code auquel il manque la comprÃ©hension des modules <em>npm</em>.
Nous allons maintenant chercher Ã  transformer le fichier <code>script-import-jquery.js</code> pour Ã  la fois rendre la syntaxe <code>import</code> intelligible  (c&#8217;est le rÃ´le de <em>babel</em>) mais aussi pour faire le lien avec les modules <em>npm</em> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run browserify -- \
  -t babelify \
  -e examples/import/script-import-jquery.js \
  -o examples/import/script-import-jquery-browserify.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette commande exÃ©cute trois choses :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>-t babelify</code> indique d&#8217;utiliser une intÃ©gration <em>babel</em> (un <em>transform</em>) pour transformer la syntaxe <em>ECMAScript 2015</em> ;</p>
</li>
<li>
<p><code>-e â¦</code> indique le script d&#8217;entrÃ©e Ã  transformer ;</p>
</li>
<li>
<p><code>-o â¦</code> indique oÃ¹ stocker le script transformÃ©.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il en rÃ©sultera un fichier nommÃ© <code>script-import-jquery-browserify.js</code> compatible <em>ECMAScript 5</em> et qui inclut dÃ©sormais le code source de jQuery.<br>
Il ne nous reste plus qu&#8217;Ã  charger le fichier transformÃ© dans notre page web pour voir le rÃ©sultat :</p>
</div>
<div class="listingblock">
<div class="title">import/import-jquery-browserify.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script src="script-import-jquery-browserify.js"&gt;&lt;/script&gt;

&lt;div id="logs"&gt;&lt;/div&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rÃ©capitulatif">3.4. RÃ©capitulatif</h3>
<div class="paragraph">
<p>En rÃ©sumÃ©, nous avons besoin de nous baser sur <em>deux ou trois outils</em> pour Ã©crire un code modulaire et compatible avec n&#8217;importe quel type de syntaxe :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>babel</strong> pour transformer la syntaxe ;</p>
</li>
<li>
<p>des <strong>polyfills</strong> pour harmoniser les fonctionnalitÃ©s ;</p>
</li>
<li>
<p><strong>browserify</strong> pour l&#8217;intÃ©gration avec les modules <em>npm</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ceux-ci ont l&#8217;avantage d&#8217;Ãªtre <em>faciles</em> Ã  prendre en main, <em>modulaires</em> et <em>Ã©volutifs</em>.
Nous pourrons aussi nous tourner vers d&#8217;autres outils de transformation de code pour explorer d&#8217;autres horizons â et il en existe Ã©normÃ©ment : <em>webpack</em>, <em>rollup</em>, <em>broccoli</em>, etc.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conception_modulaire">4. Conception modulaire</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un autre paradigme change avec la mise Ã  disposition des modules et de l&#8217;outillage Ã  disposition : le code que l&#8217;on Ã©crit dÃ©pend surtout d'<em>ECMAScript</em> et de l&#8217;environnement dans lequel on l&#8217;exÃ©cute, Ã  savoir Node ou un navigateur web.</p>
</div>
<div class="paragraph">
<p>La section suivante s&#8217;intÃ©resse Ã  l'<strong>Ã©volution de l&#8217;Ã©criture du code</strong>, autrefois dirigÃ©e par la <strong>structure du document</strong> HTML vers un monde de <strong>fonctions consommant des donnÃ©es</strong>, transformÃ©es pour un type d&#8217;affichage, que ce soit HTML ou autre.</p>
</div>
<div class="paragraph">
<p>Nous illustrerons cette Ã©volution au travers d&#8217;un exemple relativement simple : une balise HTML affichant l&#8217;heure dont nous actualisons le contenu toutes les secondes.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/modules-time.png" alt="modules time" width="85%">
</div>
<div class="title">Figure 2. RÃ©sultat de l&#8217;exemple dÃ©veloppÃ© dans les sections suivantes.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>jQuery</em></div>
<div class="paragraph">
<p>Les exemples suivants se basent sur l&#8217;utilisation de la librairie <em>jQuery</em>.
Elle facilite la manipulation du <em>DOM</em> tout en gÃ©rant les incompatibilitÃ©s des diffÃ©rents navigateurs web.
Son utilisation est devenue moins dominante du fait d&#8217;une nette amÃ©lioration de la qualitÃ© de ces derniers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://api.jquery.com/" class="bare">api.jquery.com/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="http://learn.jquery.com/using-jquery-core/" class="bare">learn.jquery.com/using-jquery-core/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="le_syndrome_du_plugin_em_jquery_em">4.1. Le syndrome du plugin <em>jQuery</em></h3>
<div class="paragraph">
<p>Ce que j&#8217;appelle le "syndrome du plugin <em>jQuery</em>", c&#8217;est une combinaison des Ã©lÃ©ments suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>crÃ©ation de <strong>code mÃ©tier inutilisable</strong> en dehors de <em>jQuery</em> ;</p>
</li>
<li>
<p><strong>mÃ©lange de la prÃ©sentation</strong> des donnÃ©es et de l&#8217;organisation du code mÃ©tier ;</p>
</li>
<li>
<p>un code <em>aveugle</em> car <strong>Ã©loignÃ© de la structure HTML</strong> nÃ©cessaire Ã  son fonctionnement ;</p>
</li>
<li>
<p><strong>fragilitÃ©</strong> du code en cas de changement de la structure HTML associÃ©e ;</p>
</li>
<li>
<p>en gÃ©nÃ©ral, un code <strong>difficilement testable</strong> â difficile de ne pas aboutir Ã  une interface boguÃ©e.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Voici un exemple de document HTML <em>fragile</em> et <em>mÃ©langeant</em> tous les concepts en mÃªme temps.
Il est parfaitement valide mais illustre un ensemble de pratiques courantes que nous allons chercher Ã  <em>dÃ©sapprendre</em>.</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-plugin.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;time datetime="" data-interval="1000"&gt;---&lt;/time&gt;

  &lt;script src="../../node_modules/jquery/dist/jquery.js"&gt;&lt;/script&gt;
  &lt;script src="jquery-plugin.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maintenant que la structure HTML est dÃ©finie, nous devons dÃ©sormais Ã©crire le code affichant l&#8217;heure dans un Ã©lÃ©ment HTML toutes les secondes&#160;:</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-plugin.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">/* global jQuery */

($ =&gt; {
  $.fn.displaySeconds = function displaySeconds() {
    this.each((i, dateElement) =&gt; {
      setInterval(() =&gt; {                  <b class="conum">(1)</b>
        const now = new Date();            <b class="conum">(2)</b>
        const seconds = now.getSeconds();

        $(dateElement)                     <b class="conum">(3)</b>
          .removeClass(seconds % 2 ? 'pair': 'impair')
          .addClass(seconds % 2 ? 'impair': 'pair')
          .attr('datetime', now.toISOString())
          .text(now.toLocaleTimeString());
      }, $(dateElement).data('interval')); <b class="conum">(4)</b>
    });

    return this;
  };

  $(document).ready(() =&gt; {      <b class="conum">(5)</b>
    $('time').displaySeconds();  <b class="conum">(6)</b>
  });
})(jQuery);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ce bloc de code est exÃ©cutÃ© toutes les secondes ;</p>
</li>
<li>
<p>La donnÃ©e de <em>temps</em> est obtenue chaque seconde par notre <em>plugin jQuery</em> ;</p>
</li>
<li>
<p>Certaines dÃ©cisions mÃ©tier sont mÃ©langÃ©es avec l&#8217;affichage de la donnÃ©e <em>temps</em> ;</p>
</li>
<li>
<p>L&#8217;intervalle est dÃ©terminÃ© par la <em>valeur de l&#8217;attribut "data-interval"</em> ;</p>
</li>
<li>
<p>Ce bloc de code est exÃ©cutÃ© dÃ¨s que le document HTML est prÃªt â toute sa structure HTML est disponible ;</p>
</li>
<li>
<p>Le <em>plugin jQuery</em> est appliquÃ© Ã  toutes les occurrences de <code>&lt;time&gt;</code> dans lequel le <em>plugin</em> est exÃ©cutÃ©.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Certains motifs illustrÃ©s dans la section <a href="#modules">Importer des modules</a> refont surface :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>variables globales : que faire si <code>jQuery</code> n&#8217;existe pas ?</p>
</li>
<li>
<p>connaissance implicite du document : que faire si une personne tierce remplace la balise <code>&lt;time&gt;</code> par une autre balise ?</p>
</li>
<li>
<p>code JavaScript pilotÃ© par le document : que faire si une personne tierce exprime l&#8217;intervalle en secondes et non en millisecondes ?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La faute n&#8217;est pas vraiment celle de <em>jQuery</em> mais plutÃ´t la nÃ´tre â enfin, la <em>mienne</em> <span class="icon">[smile o]</span>.
Nous avons <strong>mÃ©langÃ© rÃ¨gles de fonctionnement</strong> (contenu de balise, classe CSS Ã  ajouter/enlever) et donnÃ©es (date courante, paritÃ© des secondes, Ã©vÃ©nement de mise Ã  jour <code>setInterval</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="vers_une_approche_em_jquery_em_composite">4.2. Vers une approche <em>jQuery</em> composite</h3>
<div class="paragraph">
<p>Nous allons maintenant reprendre les concepts appris prÃ©cÃ©demment et conserver le mÃªme outil, Ã  savoir <em>jQuery</em>.
Certains outils encouragent de bons <em>motifs de conception</em> et donnent la sensation de rÃ©soudre des problÃ¨mes.
Apprendre ces motifs et Ã  capitaliser sur les outils que nous connaissons dÃ©jÃ  peuvent nous emmener tout aussi loin.</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-app.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;time datetime=""&gt;---&lt;/time&gt;

  &lt;script src="jquery-app-browserify.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le changement majeur rÃ©side dans la rÃ©organisation du code applicatif&#160;:</p>
</div>
<div class="listingblock">
<div class="title">modules/jquery-app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import $ from 'jquery';
import timerFn from './timer.js';                              <b class="conum">(4)</b>

const displaySeconds = (tickData, dateElement) =&gt; {            <b class="conum">(5)</b>
  const {className, now} = tickData;

  $(dateElement)                                               <b class="conum">(6)</b>
    .attr('class', className)
    .attr('datetime', now.toISOString())
    .text(now.toLocaleTimeString());
};

$(document).ready(() =&gt; {
  const dateElements = $('time').get();                        <b class="conum">(1)</b>
  const onTick = tickData =&gt; {
    dateElements.forEach(el =&gt; displaySeconds(tickData, el));  <b class="conum">(2)</b>
  };

  timerFn({ interval: 1000, onTick });                         <b class="conum">(3)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous sÃ©lectionnons les Ã©lÃ©ments de la page Ã  actualiser chaque seconde ;</p>
</li>
<li>
<p>Nous dÃ©finissons quoi faire avec les donnÃ©es transmises chaque seconde ;</p>
</li>
<li>
<p>Nous dÃ©marrons un minuteur ;</p>
</li>
<li>
<p>Le minuteur est une fonction externe, dont le comportement n&#8217;est pas rÃ©gi par <em>jQuery</em> ou une autre librairie ;</p>
</li>
<li>
<p>Cette fonction est responsable de l&#8217;affichage de <em>donnÃ©es</em> dans un <em>Ã©lÃ©ment HTML</em> ;</p>
</li>
<li>
<p>Cette fois-ci, nous nous contentons de seulement mettre Ã  jour attributs et contenus â la logique mÃ©tier a Ã©tÃ© dÃ©placÃ©e dans le module <code>timer.js</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le code a Ã©tÃ© divisÃ© en deux sections distinctes :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>celui qui dÃ©crit la <strong>rÃ©action Ã  une donnÃ©e</strong> ;</p>
</li>
<li>
<p><strong>celui qui intÃ¨gre</strong> le minuteur avec les Ã©lÃ©ments du <em>DOM</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous n&#8217;avons pas rÃ©ellement besoin de savoir comment fonctionne le minuteur Ã  ce niveau â nous avons juste besoin de pouvoir compter sur les donnÃ©es qu&#8217;il nous fournit.</p>
</div>
<div class="listingblock">
<div class="title">modules/timer.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const tick = () =&gt; {              <b class="conum">(1)</b>
  const now = new Date;

  return {                        <b class="conum">(2)</b>
    now,
    className: now.getSeconds() % 2 ? 'impair': 'pair'
  }
};

module.exports = function timer ({ onTick, interval }) {  <b class="conum">(3)</b>
  setInterval(() =&gt; onTick(tick()), interval);            <b class="conum">(4)</b>

  return tick();                  <b class="conum">(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Cette fonction (privÃ©e) est responsable de dÃ©crire le <em>temps prÃ©sent</em> sous forme d&#8217;une <strong>structure de donnÃ©es</strong> ;</p>
</li>
<li>
<p>Cette <em>structure de donnÃ©es</em> pourra retourner de nouvelles clÃ©s/valeurs sans remettre en cause le fonctionnement du code y ayant recours ;</p>
</li>
<li>
<p>Le paramÃ¨tre <code>onTick</code> est une fonction passÃ©e en argument qui sera appelÃ©e Ã  chaque nouvel intervalle de temps ;</p>
</li>
<li>
<p>La responsabilitÃ© de <code>timer</code> est de communiquer une nouvelle <em>structure de donnÃ©es</em> Ã  un intervalle de temps donnÃ© ;</p>
</li>
<li>
<p>On retourne immÃ©diatement une structure de donnÃ©es par commoditÃ© et de maniÃ¨re synchrone.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Pour un rÃ©sultat identique, nous avons dÃ©sormais sÃ©parÃ© notre code en trois <strong>domaines distincts</strong> : le <em>minuteur</em>, l'<em>intÃ©gration</em> du minuteur, la <em>reprÃ©sentation</em> du minuteur sous forme HTML.
Cerise sur le gÃ¢teau, cette <em>distinction se constate visuellement</em>, au premier coup d&#8217;Åil.</p>
</div>
<div class="paragraph">
<p>Tout n&#8217;est pas parfait, car nous sommes encore liÃ©s Ã  la structure du document HTML.</p>
</div>
</div>
<div class="sect2">
<h3 id="partager_le_code_mÃ©tier_avec_node">4.3. Partager le code mÃ©tier avec Node</h3>
<div class="paragraph">
<p>Cette <em>sÃ©paration de principes</em> (<em>separation of concerns</em>) va au-delÃ  du plaisir de l&#8217;esthÃ¨te.
Nous venons sans le savoir de crÃ©er du <strong>code <em>ECMAScript</em> universel</strong>.</p>
</div>
<div class="paragraph">
<p>Pourquoi <em>universel</em> ?
Parce que nous pouvons tout aussi bien l&#8217;inclure et l&#8217;exÃ©cuter dans Node que dans un navigateur web :</p>
</div>
<div class="listingblock">
<div class="title">modules/node-timer.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const timerFn = require('./timer.js');

timerFn({ interval: 1000, onTick: console.log });</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exÃ©cution du script <code>node-timer.js</code> afficherait quelque chose du genre dans votre terminal :</p>
</div>
<div class="listingblock">
<div class="content">
<pre><span data-bash-subs="$"></span>node examples/modules/node-timer.js
{ now: 2017-02-17T11:07:29.752Z, className: 'impair' }
{ now: 2017-02-17T11:07:30.762Z, className: 'pair' }
{ now: 2017-02-17T11:07:31.768Z, className: 'impair' }
{ now: 2017-02-17T11:07:32.770Z, className: 'pair' }
{ now: 2017-02-17T11:07:33.775Z, className: 'impair' }
{ now: 2017-02-17T11:07:34.779Z, className: 'pair' }
^C</pre>
</div>
</div>
<div class="paragraph">
<p>Chaque seconde, la fonction <code>console.log</code> est appelÃ©e et affiche la <em>structure de donnÃ©es</em> de notre minuteur dans la <em>sortie standard</em> du terminal.</p>
</div>
<div class="paragraph">
<p>Nous pourrions dÃ¨s Ã  prÃ©sent utiliser le minuteur dans d&#8217;autres applications, cÃ´tÃ© client, cÃ´tÃ© serveur et pourquoi pas un jour, le publier sur le <em>registre npm</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sÃ©paration_du_fond_et_de_la_forme_donnÃ©es_rendu_et_interactions">4.4. SÃ©paration du fond et de la forme : donnÃ©es, rendu et interactions</h3>
<div class="paragraph">
<p>Les praticienÂ·neÂ·s de l&#8217;intÃ©gration web nous le dirons souvent : il faut <strong>sÃ©parer le fond de la forme</strong>.
Il en est de mÃªme dans notre code â et pas que pour le dÃ©veloppement <em>frontend</em>.</p>
</div>
<div class="paragraph">
<p>Un code maintenable n&#8217;a pas besoin d&#8217;Ãªtre complexe.
Un code maintenable a surtout besoin de bien <em>isoler</em> ses pÃ©rimÃ¨tres d&#8217;intervention.</p>
</div>
<div class="paragraph">
<p>Les exemples prÃ©cÃ©dents nous ont permis de dÃ©celer trois pÃ©rimÃ¨tres phares :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>donnÃ©es</strong> : des structures prÃ©dictibles, obtenues ou modifiÃ©es ;</p>
</li>
<li>
<p><strong>rendu</strong> : la reprÃ©sentation des donnÃ©es en <em>contexte</em>, que ce soit une page HTML, un terminal ou un fichier CSV ;</p>
</li>
<li>
<p><strong>interactions</strong> : des Ã©vÃ©nements dÃ©clenchÃ©s par les utilisateurs, par des facteurs externes ou des rÃ¨gles mÃ©tier â ils impactent les <em>donnÃ©es</em> et leur <em>reprÃ©sentation</em>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="react">4.5. Rapprocher donnÃ©es, rendu et interactions avec <em>React</em></h3>
<div class="paragraph">
<p><em>React</em> a atteint un pic de popularitÃ© certain en 2015 et 2016.
Pas seulement parce qu&#8217;il s&#8217;agit d&#8217;un outil bien conÃ§u mais justement parce qu&#8217;il encourage cette pratique de la <strong>reprÃ©sentation des donnÃ©es</strong>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> API React</div>
<div class="paragraph">
<p>Les exemples suivants se basent sur la librairie <em>React</em>.
Sa documentation offre de bons exemples pour se familiariser avec son utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://facebook.github.io/react/" class="bare">facebook.github.io/react/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://facebook.github.io/react/docs/thinking-in-react.html" class="bare">facebook.github.io/react/docs/thinking-in-react.html</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notre code HTML n&#8217;est qu&#8217;un <strong>rÃ©sultat</strong> exposant des <strong>surfaces d&#8217;interaction</strong>.
Notre code se structure en <strong>composants</strong>.
Un <em>composant</em> est responsable de deux choses : la <strong>reprÃ©sentation de donnÃ©es</strong> et la <strong>rÃ©action Ã  des Ã©vÃ©nements</strong>.</p>
</div>
<div class="paragraph">
<p>Cela se traduira par un changement de taille : l&#8217;exemple que nous avons fait Ã©voluer ne fait plus mention de balise <code>&lt;time&gt;</code> mais expose une balise dÃ©diÃ©e Ã  contenir notre <em>composant minuteur</em> :</p>
</div>
<div class="listingblock">
<div class="title">modules/react-app.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;body&gt;
  &lt;link rel="stylesheet" type="text/css" href="styles.css"&gt;

  &lt;div id="app"&gt;&lt;/div&gt;

  &lt;script src="react-app-browserify.js"&gt;&lt;/script&gt;
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notre code applicatif est rÃ©duit Ã  son plus strict minimum :</p>
</div>
<div class="listingblock">
<div class="title">modules/react-app.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { createElement } from 'react';
import ReactDOM from 'react-dom';
import DateInterval from './date-interval.jsx';

ReactDOM.render(                                  <b class="conum">(1)</b>
  createElement(DateInterval, {interval: 1000}),  <b class="conum">(2)</b>
  document.querySelector('#app')                  <b class="conum">(3)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>MÃ©thode responsable du rendu HTML de notre composant <code>TimeInterval</code> dans l&#8217;Ã©lÃ©ment <code>&lt;div id="app"&gt;</code> ;</p>
</li>
<li>
<p>CrÃ©ation de notre composant minuteur avec un intervalle de mise Ã  jour de 1000 millisecondes ;</p>
</li>
<li>
<p>Indication que le rendu du composant sera effectuÃ© <em>dans</em> l&#8217;Ã©lÃ©ment <code>&lt;div id="app"&gt;</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cela ressemble fortement au contenu de nos prÃ©cÃ©dentes invocations de <code>$(document).ready()</code> mais sans avoir Ã  se soucier du fonctionnement interne du minuteur.</p>
</div>
<div class="paragraph">
<p>La reprÃ©sentation et le fonctionnement du minuteur sont dÃ©sormais regroupÃ©s dans un seul composant :</p>
</div>
<div class="listingblock">
<div class="title">modules/date-interval.jsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jsx hljs" data-lang="jsx">import React, { Component } from 'react';
import timerFn from './timer.js';

export default class DateInterval extends Component {        <b class="conum">(1)</b>
  constructor(props) {                                       <b class="conum">(2)</b>
    super(props);

    const {interval} = props;
    this.onTick = this.onTick.bind(this);

    this.state = {
      tickData: timerFn({ interval, onTick: this.onTick })   <b class="conum">(3)</b>
    };
  }

  onTick (tickData) {
    this.setState({ tickData });                   <b class="conum">(4)</b>
  }

  render() {                                       <b class="conum">(5)</b>
    const {className, now} = this.state.tickData;  <b class="conum">(6)</b>

    return (&lt;time className={className} dateTime={now.toISOString()}&gt;
      {now.toLocaleTimeString()}
    &lt;/time&gt;);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous exportons un composant <em>React</em> grÃ¢ce Ã  l&#8217;opÃ©rateur <em>ECMAScript 2015</em> <code>extends</code> â cf. la <a href="../chapter-03/index.html#primitive-class">section Class du Chapitre 3</a> ;</p>
</li>
<li>
<p>Le <code>constructor</code> est exÃ©cutÃ© quand le composant est rendu dans le document ;</p>
</li>
<li>
<p>La propriÃ©tÃ© <code>interval</code> nous est fournie dans <code>react-app.js</code> et nous stockons la <em>structure de donnÃ©e</em> retournÃ©e par le minuteur tout en dÃ©clenchant son actualisation toutes les 1000 millisecondes ;</p>
</li>
<li>
<p>Ã chaque intervalle, nous mettons Ã  jour la valeur <code>tickData</code> de l&#8217;Ã©tat interne du composant (<code>this.state</code>) ;</p>
</li>
<li>
<p>La mÃ©thode <code>render()</code> est exÃ©cutÃ©e quand le composant est insÃ©rÃ© dans un document pour la premiÃ¨re fois et dÃ¨s que l&#8217;Ã©tat interne (<code>this.state</code>) change ;</p>
</li>
<li>
<p>Nous dÃ©structurons la valeur connue de <code>tickData</code> pour effectuer une opÃ©ration qui nous rappelle les diffÃ©rents appels Ã  <code>.attr('class')</code> et <code>.text()</code> de <em>jQuery</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><em>React</em> introduit quatre concepts au sein des composants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un <strong>cycle de vie</strong> basÃ© sur des <em>propriÃ©tÃ©s</em> (<em>props</em>) et un <em>Ã©tat interne</em> (<em>state</em>) ;</p>
</li>
<li>
<p>des <strong>propriÃ©tÃ©s immuables</strong> pour le paramÃ©trage initial ;</p>
</li>
<li>
<p>un <strong>Ã©tat interne mutable</strong> pour contenir les changements et demander une actualisation de leur reprÃ©sentation dans le document.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>React</em> dÃ©termine les opÃ©rations Ã  effectuer dans le document HTML en fonction de la lourdeur des opÃ©rations : (re)crÃ©ation complÃ¨te de <code>&lt;time&gt;</code> dans le nÅud parent, simple mise Ã  jour d&#8217;un ou plusieurs attributs ou encore dÃ©placement du composant ailleurs dans le document HTML, etc.</p>
</div>
<div class="paragraph">
<p>L&#8217;intelligence d&#8217;une librairie comme <em>React</em> est d&#8217;encourager Ã  dÃ©crire les donnÃ©es et leur rendu pour se charger des opÃ©rations d&#8217;Ã©criture dans le DOM.
Cela permet de crÃ©er des composants faciles Ã  isoler, Ã  rÃ©utiliser et Ã  tester.</p>
</div>
<div class="paragraph">
<p>Cette approche nous a permis de rÃ©utiliser notre minuteur simplement en adaptant son utilisation.
<em>React</em> nous permet de <strong>diriger l&#8217;affichage</strong> du document plutÃ´t que d&#8217;en dÃ©pendre.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Outil</span> React Developer Tools</div>
<div class="paragraph">
<p>Cette extension pour le navigateur Chrome dÃ©taille l&#8217;arborescence des composants montÃ©s dans le document HTML ainsi qu&#8217;une vue de leurs propriÃ©tÃ©s respectives.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/react-devtools.png" alt="react devtools" width="85%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi" class="bare">chrome.google.com/webstore/detail/fmkadmapgofadopljbjfkapdkoienihi</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="io">5. Des requÃªtes AJAX au temps-rÃ©el</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les technologies web offrent un panel de fonctionnalitÃ©s crÃ©atives et versatiles.
Le boom du <em>Web 2.0</em> a coÃ¯ncidÃ© avec la redÃ©couverte de <code>XMLHttpRequest</code>, une API initialement crÃ©Ã©e par Microsoft pour <strong>transfÃ©rer des donnÃ©es entre client et serveur</strong>, de <em>maniÃ¨re non-bloquante</em>.
Cette fonctionnalitÃ© a permis de basculer vers un monde de pages dynamiques et rapides Ã  charger.
Des applications web comme Google Maps, Gmail ou la recherche instantanÃ©e de Google ont parachevÃ© la popularisation de cette technique.</p>
</div>
<div class="paragraph">
<p>Toutefois son API est peu intuitive et est unidirectionnelle, dirigÃ©e <strong>du client vers le serveur</strong>.
Le terme <code>XMLHttpRequest</code> est parfois nommÃ© <code>AJAX</code> ou <code>xhr</code>.</p>
</div>
<div class="paragraph">
<p>Un mÃªme exemple cÃ´tÃ© client sera dÃ©veloppÃ© et successivement adaptÃ© aux technologies <code>fetch()</code>, <em>EventSource</em> puis <em>WebSocket</em>.
Il nous permettra d&#8217;en faire Ã©merger les principes, leurs cas d&#8217;usage ainsi que leur possible intÃ©gration avec Node.<br>
L&#8217;implÃ©mentation cÃ´tÃ© serveur est basÃ©e sur un serveur <a href="../chapter-07/index.html#express">Express.js</a> dont l&#8217;usage est expliquÃ© au chapitre 7.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/io-example.png" alt="io example" width="85%">
</div>
<div class="title">Figure 3. RÃ©sultat attendu dans les exemples des sections suivantes.</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> Node, mais pas que.</div>
<div class="paragraph">
<p><code>fetch()</code>, <em>EventSource</em> et <em>WebSocket</em> reposent sur le protocole HTTP/1 et ses extensions.
Il est important de comprendre que leur contrepartie "cÃ´tÃ© serveur" existe aussi dans d&#8217;autres langages et environnements comme Ruby, Python et PHP.</p>
</div>
<div class="paragraph">
<p>Il se trouve que la nature asynchrone mÃªme de Node rend cette intÃ©gration relativement aisÃ©e et triviale, aussi et en grande partie grÃ¢ce Ã  l&#8217;Ã©cosystÃ¨me <em>npm</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="io-fetch">5.1. Ãchange ponctuel de donnÃ©es avec <code>fetch()</code></h3>
<div class="paragraph">
<p><code>fetch()</code> offre une interface trÃ¨s simple pour appeler une ressource HTTP.
Le rÃ©sultat est retournÃ© sous forme de <em>promesse</em> (voir la <a href="../chapter-03/index.html#promise">section <em>Promise</em></a> du Chapitre 3).
Cette fonction sert aussi bien Ã  obtenir des ressources avec des requÃªtes de type <code>GET</code> et <code>HEAD</code> qu&#8217;Ã  en crÃ©er et modifier avec des requÃªtes de type <code>POST</code>, <code>PUT</code>, <code>DELETE</code> et <code>PATCH</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple associÃ© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/fetch.html" class="bare">localhost:4000/examples/io/fetch.html</a></span>.
Nous pouvons vÃ©rifier la compatibilitÃ© navigateur de <code>fetch()</code> sur <span class="URL"><a href="http://caniuse.com#feat=fetch" class="bare">caniuse.com#feat=fetch</a></span>.</p>
</div>
<div class="paragraph">
<p>Le dÃ©roulÃ© d&#8217;exÃ©cution d&#8217;un appel Ã  <code>fetch()</code> est le suivant :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>construction de la <strong>requÃªte</strong> (<em>URL</em> ou objet <code>Request</code>, options) ;</p>
</li>
<li>
<p><strong>rÃ©ception</strong> des entÃªtes de la <em>rÃ©ponse</em> (objet <code>Response</code>) ;</p>
</li>
<li>
<p><strong>dÃ©codage</strong> de la <em>rÃ©ponse</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Plusieurs <em>dÃ©codeurs de rÃ©ponse</em> sont fournis nativement : texte (<code>response.text()</code>), JSON (<code>response.json()</code>), ArrayBuffer (<code>response.arrayBuffer()</code>), Blob (<code>response.blob()</code>) et FormData (<code>response.formData()</code>).</p>
</div>
<div class="listingblock">
<div class="title">io/fetch-client.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const userList = document.querySelector('#user-list');

setInterval(() =&gt; {
  fetch('/new-users')                    <b class="conum">(1)</b>
    .then(response =&gt; response.text())   <b class="conum">(2)</b>
    .then(data =&gt; {                      <b class="conum">(3)</b>
      const li = document.createElement('li');
      li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

      userList.prepend(li);
    })
}, 2000);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ExÃ©cution de la requÃªte HTTP <em>GET</em> vers <code>/new-users</code> depuis le navigateur web courant ;</p>
</li>
<li>
<p>DÃ©codage progressif de la rÃ©ponse ;</p>
</li>
<li>
<p>Une fois le dÃ©codage terminÃ©, le rÃ©sultat de la requÃªte HTTP est mis Ã  disposition â ici, sous forme de chaÃ®ne de caractÃ¨res.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/fetch-frames.png" alt="fetch frames" width="85%">
</div>
<div class="title">Figure 4. Traces rÃ©seau d&#8217;appels successifs Ã  <code>fetch()</code> ; chacun rÃ©sultant en une nouvelle requÃªte HTTP.</div>
</div>
<div class="paragraph">
<p>L&#8217;implÃ©mentation d&#8217;une ressource HTTP cÃ´tÃ© serveur s&#8217;effectue simplement en retournant une <em>rÃ©ponse</em> lors d&#8217;une <em>requÃªte</em> HTTP :</p>
</div>
<div class="listingblock">
<div class="title">io/fetch-server.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const chance = require('chance').Chance();

module.exports = (app) =&gt; {
  app.get('/new-users', (req, res) =&gt; {
    res.send(chance.name());
  });
};</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Guide</span> Collection d&#8217;exemples</div>
<div class="paragraph">
<p>Le guide communautaire <em>MDN</em> met Ã  disposition une dizaine d&#8217;exemples pour illustrer diffÃ©rents cas d&#8217;utilisation de <code>fetch()</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://github.com/mdn/fetch-examples" class="bare">github.com/mdn/fetch-examples</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En <em>rÃ©sumÃ©</em>, <code>fetch()</code> est idÃ©al pour des demandes ponctuelles de donnÃ©es, du client vers le serveur.
Le module <em>npm</em> <code>node-fetch</code> (<span class="URL"><a href="https://npmjs.com/node-fetch" class="bare">npmjs.com/node-fetch</a></span>) est une implÃ©mentation de <code>fetch()</code> pour Node tandis que <code>whatwg-fetch</code> (<span class="URL"><a href="https://npmjs.com/whatwg-fetch" class="bare">npmjs.com/whatwg-fetch</a></span>) s&#8217;adresse uniquement Ã  polyfiller les navigateurs web.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-eventsource">5.2. Approche unidirectionnelle avec <em>EventSource</em></h3>
<div class="paragraph">
<p><em>EventSource</em> est un mÃ©canisme moins connu que <code>fetch()</code> ou <em>WebSocket</em> mais tire ses origines de la technologie <em>Comet</em>.
On peut l&#8217;assimiler Ã  une inversion de <code>fetch()</code> : le client appelle une ressource serveur, maintient une connexion de longue durÃ©e et attend un ou plusieurs <em>messages</em> dudit serveur.</p>
</div>
<div class="paragraph">
<p>Chaque connexion est ouverte en faisant appel Ã  la construction d&#8217;un objet <code>EventSource</code>.
Cet objet Ã©met alors plusieurs types d&#8217;Ã©vÃ©nements en fonction des actions :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>open</code> : lorsque le client a effectuÃ© une connexion au serveur ;</p>
</li>
<li>
<p><code>message</code> : lorsque le serveur Ã©met des donnÃ©es Ã  destination du client ;</p>
</li>
<li>
<p><code>close</code> : lorsque la connexion est fermÃ©e par le serveur ;</p>
</li>
<li>
<p><code>error</code> : lorsque la connexion est accidentellement interrompue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ce modÃ¨le de connexion permet tout aussi bien d&#8217;avoir un canal de donnÃ©es unique avec chaque utilisateur ou encore d&#8217;Ã©mettre les mÃªmes donnÃ©es en temps rÃ©el Ã  destination de tous les usagers.</p>
</div>
<div class="paragraph">
<p>Lâexemple associÃ© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/eventsource.html" class="bare">localhost:4000/examples/io/eventsource.html</a></span>.
Nous pouvons vÃ©rifier la compatibilitÃ© navigateur de <em>EventSource</em> sur <span class="URL"><a href="http://caniuse.com#feat=eventsource" class="bare">caniuse.com#feat=eventsource</a></span>.</p>
</div>
<div class="listingblock">
<div class="title">io/eventsource-client.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const connection = new EventSource('/new-users');      <b class="conum">(1)</b>
const userList = document.querySelector('#user-list');

connection.addEventListener('message', ({data}) =&gt; {   <b class="conum">(2)</b>
  const li = document.createElement('li');
  li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

  userList.prepend(li);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une nouvelle connexion <em>Event Source</em> de longue durÃ©e depuis le navigateur web courant ;</p>
</li>
<li>
<p>Fonction appelÃ©e Ã  chaque fois que le serveur transmet un message au client.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/eventsource-frames.png" alt="eventsource frames" width="85%">
</div>
<div class="title">Figure 5. Plusieurs messages peuvent Ãªtre transmis par le biais d&#8217;une seule connexion HTTP avec <em>EventSource</em>.</div>
</div>
<div class="paragraph">
<p>L&#8217;implÃ©mentation d'<em>EventSource</em> demande un peu d&#8217;efforts cÃ´tÃ© serveur mais ne nÃ©cessite pas de <em>framework</em> particulier.
La complexitÃ© rÃ©side dans le maintien d&#8217;une transmission de donnÃ©es dÃ©diÃ©e Ã  chaque client ainsi qu&#8217;Ã  la libÃ©ration de la connexion lorsque le client se dÃ©connecte.</p>
</div>
<div class="listingblock">
<div class="title">io/eventsource-server.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const WebSocket = require('faye-websocket');
const {EventSource} = WebSocket;

const chance = require('chance').Chance();

module.exports = (app) =&gt; {
  app.get('/new-users', (req, res, next) =&gt; {
    if (!EventSource.isEventSource(req)) {      <b class="conum">(1)</b>
      return next();
    }

    let es = new EventSource(req, res);         <b class="conum">(2)</b>
    const loop = setInterval(() =&gt; {
      es.send(chance.name());                   <b class="conum">(3)</b>
    }, 2000);

    es.on('close', () =&gt; {
      clearInterval(loop);
      es = null;
      next();
    });
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Une connexion <em>EventSource</em> s&#8217;effectue (presque) comme une requÃªte HTTP classique â il convient de vÃ©rifier qu&#8217;elle s&#8217;annonce en tant que telle ;</p>
</li>
<li>
<p>CrÃ©ation d&#8217;un canal unique entre le client et le serveur ;</p>
</li>
<li>
<p>Chaque appel Ã  <code>es.send</code> enverra un nouveau message au client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le serveur est responsable de la gestion des connexions demandÃ©es par les diffÃ©rents clients.</p>
</div>
<div class="admonitionblock  info">
<table>
<tr>
<td class="icon">
<div class="title">ð</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> EventSource</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur EventSource.<br>
<a href="https://developer.mozilla.org/docs/fr/Server-sent_events" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/Server-sent_events</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En rÃ©sumÃ©, <em>EventSource</em> est idÃ©al pour maintenir une connexion avec le serveur et souscrire Ã  des mises Ã  jour en continu.
Chaque connexion <em>EventSource</em> devrait concerner qu&#8217;un seul et mÃªme type d&#8217;Ã©vÃ©nement.</p>
</div>
</div>
<div class="sect2">
<h3 id="io-websocket">5.3. Ãchanges en temps-rÃ©el avec <em>WebSocket</em></h3>
<div class="paragraph">
<p><em>WebSocket</em> est une technologie web favorisant les Ã©changes bidirectionnels entre client et serveur.</p>
</div>
<div class="paragraph">
<p>Ã l&#8217;inverse du protocole HTTP/1, tout message envoyÃ© par le client ou par le serveur n&#8217;appelle pas Ã  une rÃ©ponse de la part du receveur.
Cet Ã©lÃ©ment ainsi que le maintien d&#8217;une connexion permanente expliquent la rapiditÃ© du protocole en comparaison avec le modÃ¨le requÃªte/rÃ©ponse.</p>
</div>
<div class="paragraph">
<p>Lâexemple associÃ© est accessible sur <span class="URL"><a href="http://localhost:4000/examples/io/websocket.html" class="bare">localhost:4000/examples/io/websocket.html</a></span>.
Nous pouvons vÃ©rifier la compatibilitÃ© navigateur de <em>WebSocket</em> sur <span class="URL"><a href="http://caniuse.com#feat=websocket" class="bare">caniuse.com#feat=websocket</a></span>.</p>
</div>
<div class="listingblock">
<div class="title">io/websocket-client.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">let ws = new WebSocket('ws://localhost:4000/users');    <b class="conum">(1)</b>
const userList = document.querySelector('#user-list');
let interval;

ws.addEventListener('open', () =&gt; {
  interval = setInterval(() =&gt; {
    ws.send(JSON.stringify({ action: 'getName' }));     <b class="conum">(2)</b>
  }, 2000);
});

ws.addEventListener('message', ({data}) =&gt; {            <b class="conum">(3)</b>
  const li = document.createElement('li');
  li.textContent = `${new Date().toLocaleTimeString()} : ${data}`;

  userList.prepend(li);
});

ws.addEventListener('close', () =&gt; {
  ws = null;
  clearInterval(interval);
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nous ouvrons une connexion <em>WebSocket</em> depuis le navigateur web courant ;</p>
</li>
<li>
<p>Ãmission d&#8217;un message Ã  destination du serveur ;</p>
</li>
<li>
<p>RÃ©action Ã  un message Ã©mis par le serveur.</p>
</li>
</ol>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/websocket-frames.png" alt="websocket frames" width="85%">
</div>
<div class="title">Figure 6. Trame de messages envoyÃ©s par le client (sur fond vert) et par le serveur.</div>
</div>
<div class="paragraph">
<p>L&#8217;implÃ©mentation cÃ´tÃ© serveur est lÃ©gÃ¨rement plus compliquÃ©e qu&#8217;avec <em>EventSource</em> pour la simple et bonne raison que <em>Websocket</em> est une surcouche du protocole <code>ws</code>.
HTTP n&#8217;est utilisÃ© que comme canal de communication pour Ã©tablir un lien avec le serveur <code>ws</code>.
HTTP sert de tunnel tandis que le dialogue entre client et serveur s&#8217;effectue dans un dialecte comprÃ©hensible uniquement de clients <em>WebSocket</em>.</p>
</div>
<div class="paragraph">
<p>Il est nÃ©cessaire d&#8217;utiliser un module <em>npm</em> <em>WebSocket</em> comme <em>faye</em> (<span class="URL"><a href="https://npmjs.com/faye-websocket" class="bare">npmjs.com/faye-websocket</a></span>) ou <em>socket.io</em> (<span class="URL"><a href="https://npmjs.com/socket.io" class="bare">npmjs.com/socket.io</a></span>) Ã  moins de vouloir rÃ©implÃ©menter le protocole soi-mÃªme.
Le motif de conception est similaire Ã  <em>EventSource</em>, Ã  la diffÃ©rence prÃ¨s qu&#8217;il faut aussi Ã©couter les messages transmis par le client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Remarque</span> HTTP et le statut <code>101 Switching Protocols</code></div>
<div class="paragraph">
<p>Voici ce qui se passe lorsqu&#8217;un client <em>WebSocket</em> se connecte sur <code>ws://example.com</code> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>requÃªte HTTP <code><a href="http://example.com" class="bare">example.com</a></code> standard contenant les entÃªtes <code>Upgrade: websocket</code> et <code>Connection: Upgrade</code> ;</p>
</li>
<li>
<p>le serveur HTTP rÃ©pond avec un statut <code>101 Switching Protocols</code> ;</p>
</li>
<li>
<p>le serveur <em>WebSocket</em> prend le relais dans le dialogue client/serveur ;</p>
</li>
<li>
<p>client et serveur communiquent dÃ©sormais via le protocole <code>ws</code> au sein de la connexion HTTP initiale.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Par extension et de par la nature mÃªme du protocole <code>ws</code>, il serait tout Ã  fait possible que <em>et</em> clients <em>et</em> serveur soient des agents Node.
Autrement dit, un client <em>WebSocket</em> n&#8217;a pas nÃ©cessairement Ã  Ãªtre un navigateur web.</p>
</div>
<div class="listingblock">
<div class="title">io/websocket-server.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const WebSocket = require('faye-websocket');
const chance = require('chance').Chance();

module.exports = (server) =&gt; {
  server.on('upgrade', (req, socket, body, next) =&gt; {  <b class="conum">(1)</b>
    if (!WebSocket.isWebSocket(req)) {           <b class="conum">(2)</b>
      return next();
    }

    let ws = new WebSocket(req, socket, body);   <b class="conum">(3)</b>

    ws.on('message', event =&gt; {                  <b class="conum">(4)</b>
      const data = JSON.parse(event.data);

      if (data.action === 'getName') {
        ws.send(chance.name());                  <b class="conum">(5)</b>
      }
    });

    ws.on('close', () =&gt; {
      ws = null;
    });
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le serveur HTTP vient de rÃ©pondre avec un statut <code>101 Switching Protocols</code> et dÃ©lÃ¨gue dÃ©sormais la responsabilitÃ© du dialogue client/serveur ;</p>
</li>
<li>
<p>Nous vÃ©rifions que le changement de protocole concerne le protocole <code>ws</code> ;</p>
</li>
<li>
<p>La connexion rÃ©seau (<code>socket</code>) est transmise au serveur <em>WebSocket</em> pour amorcer le dialogue client/serveur avec le protocole <code>ws</code> ;</p>
</li>
<li>
<p>RÃ©action Ã  la rÃ©ception d&#8217;un message client ;</p>
</li>
<li>
<p>Ãmission d&#8217;un message Ã  destination d&#8217;un client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>LÃ  aussi, le serveur est responsable de la gestion des connexions demandÃ©es par les diffÃ©rents clients.</p>
</div>
<div class="admonitionblock  info">
<table>
<tr>
<td class="icon">
<div class="title">ð</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> WebSockets</div>

Rendez-vous sur <em>MDN web docs</em> pour en savoir plus sur WebSockets.<br>
<a href="https://developer.mozilla.org/docs/fr/WebSockets" class="bare URL" target="_blank" rel="noopener">developer.mozilla.org/docs/fr/WebSockets</a>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En rÃ©sumÃ©, <em>WebSocket</em> est idÃ©al pour maintenir une connexion en temps-rÃ©el et pour relayer plusieurs messages Ã  l&#8217;initiative du serveur et de tout client connectÃ© â qu&#8217;il s&#8217;agisse d&#8217;un navigateur web ou d&#8217;un agent Node.
Chaque connexion <em>WebSocket</em> peut encapsuler plusieurs types de messages.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dÃ©velopper_au_quotidien">6. DÃ©velopper au quotidien</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous avons beaucoup parlÃ© de nouvelles techniques et de modularisation.
Cela peut sembler rebutant, notamment par l&#8217;introduction d&#8217;outils auxquels nous ne sommes pas encore familiers.</p>
</div>
<div class="paragraph">
<p>L&#8217;Ã©cosystÃ¨me Node fournit Ã©normÃ©ment d&#8217;outils qui devraient nous faire <strong>gagner du temps</strong>, en nous aidant Ã  exÃ©cuter des actions <strong>lorsqu&#8217;un fichier est modifiÃ©</strong>, en nous aidant Ã  <strong>organiser notre travail</strong> mais aussi en <strong>actualisant automatiquement notre application web</strong> au fil du dÃ©veloppement (fini les appuis rÃ©pÃ©tÃ©s sur la touche <kbd>F5</kbd>) ou encore en <strong>optimisant nos fichiers graphiques</strong>.</p>
</div>
<div class="sect2">
<h3 id="watchify">6.1. Reconstruire en continu avec <code>watchify</code></h3>
<div class="paragraph">
<p>L&#8217;utilisation de <a href="#browserify">browserify</a> nous apporte le confort de pouvoir inclure des modules <em>npm</em> dans les navigateurs web.
En revanche, Ã§a nous demande de gÃ©nÃ©rer des artÃ©facts â des <em>bundles</em> â Ã  chaque modification pour consolider ces changements.</p>
</div>
<div class="paragraph">
<p>C&#8217;est Ã  ce moment qu&#8217;intervient le module <em>watchify</em> (<span class="URL"><a href="https://npmjs.com/watchify" class="bare">npmjs.com/watchify</a></span>).
Il fonctionne <strong>exactement comme <em>browserify</em></strong> mais au lieu de compiler une seule fois, il compilera dÃ¨s qu&#8217;un changement sera dÃ©tectÃ© â oÃ¹ que ce soit dans l&#8217;arbre de dÃ©pendances du point d&#8217;entrÃ©e (paramÃ¨tre <code>-e</code>, <code>--entrypoint</code>).</p>
</div>
<div class="paragraph">
<p>La commande suivante compilerait le fichier <code>examples/modules/react-app.js</code> une fois et une seule :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/browserify -t babelify -e examples/modules/react-app.js -o examples/modules/react-app-browserify.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Il suffit de remplacer <code>browserify</code> par <code>watchify</code> â le programme garde la main et indique chaque nouvelle compilation sur une nouvelle ligne :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/watchify -dv -t babelify -e examples/modules/react-app.js -o examples/modules/react-app-browserify.js
1840601 bytes written to examples/modules/react-app-browserify.js (2.58 seconds) at 4:44:28 PM
352482 bytes written to examples/modules/react-app-browserify.js (0.10 seconds) at 4:45:09 PM
1840605 bytes written to examples/modules/react-app-browserify.js (0.25 seconds) at 4:45:15 PM</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>watchify</em> utilise un mÃ©canisme dit de <strong>compilation incrÃ©mentale</strong> : <em>watchify</em> ne recompile pas tout mais uniquement les diffÃ©rences depuis le dernier changement.
C&#8217;est beaucoup plus rapide et tout aussi efficace.</p>
</div>
<div class="paragraph">
<p>Trois arguments sont utiles Ã  <em>watchify</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-v</code> (<code>--verbose</code>) : force la crÃ©ation du fichier compilÃ© au lancement de la commande ;</p>
</li>
<li>
<p><code>-o</code> (<code>--outfile</code>) : spÃ©cifie le chemin d&#8217;enregistrement du fichier compilÃ© â il est impossible d&#8217;utiliser la <a href="../chapter-04/index.html#stdio">sortie standard</a> (cf. Chapitre 4) ;</p>
</li>
<li>
<p><code>-d</code> (<code>--debug</code>) : (lire <a href="#browserify-sourcemaps"><em>Source Maps</em></a> dans ce mÃªme chapitre).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="livereload">6.2. Changements en temps-rÃ©el dans le navigateur</h3>
<div class="paragraph">
<p>Modifier un fichier. Changer de fenÃªtre. Recharger. Changer de fenÃªtre. Re-modifier un fichier. Changer de fenÃªtre. Recharger. <em>LÃ </em> c&#8217;est bon.<br>
La quantitÃ© d&#8217;outils Ã  disposition et leurs diffÃ©rentes opinions sur notre maniÃ¨re de travailler nous obligent Ã  prendre des postures de travail qui ne vont <strong>pas nÃ©cessairement dans le sens de la productivitÃ©</strong>.</p>
</div>
<div class="paragraph">
<p>L&#8217;intÃ©gration de Node avec le systÃ¨me d&#8217;exploitation va nous aider Ã  dÃ©clencher des actions lorsqu&#8217;un ou plusieurs fichiers sont modifiÃ©s.
Ces modifications peuvent Ãªtre de notre fait, directement ou par le biais d&#8217;un autre logiciel (un optimiseur d&#8217;images ou la <a href="#node-sass">compilation d&#8217;un fichier <em>Sass</em></a> par exemple).</p>
</div>
<div class="paragraph">
<p>Nous allons explorer <em>deux stratÃ©gies</em> d&#8217;actualisation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le <strong>rafraichissement automatique du navigateur</strong> ;</p>
</li>
<li>
<p>le <strong>remplacement de modules Ã  chaud</strong> (<em>Hot Module Replacement</em>, <em>HMR</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>browser-sync</em> est un outil formidable de dÃ©veloppement pour <strong>rafraichir automatiquement une page web</strong> si son contenu ou une des ressources associÃ©es change.
Il offre Ã©galement la possibilitÃ© de <strong>propager les changements sur plusieurs fenÃªtres et terminaux</strong> â y compris les clics, <em>scrolls</em> et toute interaction avec des formulaires.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de synchronisation d&#8217;affichage et de contenus entre deux fenÃªtres avec <em>browser-sync</em>.</div>
<div class="content">
<video src="./videos/browser-sync.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p><em>browser-sync</em> maintient la position du scroll lors d&#8217;un rechargement de contenu.
L&#8217;outil se lance soit de maniÃ¨re autonome, soit en <em>proxy</em> entre l&#8217;utilisateur et tout autre serveur web.
Il ne nÃ©cessite pas non plus de <em>plugin</em> ou d&#8217;extension navigateur pour fonctionner, le rendant idÃ©al pour du prototypage, de la recherche utilisateur ou du dÃ©veloppement local.</p>
</div>
<div class="listingblock">
<div class="title">Lancement d&#8217;un serveur web autonome avec synchronisation sur le port 4000.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/browser-sync start --server --port 4000 .</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant illustre l&#8217;intÃ©gration de <em>browser-sync</em> avec le serveur web exposant les exemples de ce chapitre (voir le dÃ©tail dans le fichier <code>server.js</code>) :</p>
</div>
<div class="listingblock">
<div class="title">livereload/server-sync.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const browserSync = require('browser-sync');

module.exports = (server) =&gt; {             <b class="conum">(1)</b>
  return port =&gt; {                         <b class="conum">(2)</b>
    const PUBLIC_PORT = 4000;              <b class="conum">(3)</b>
    const bs = browserSync.create();

    server.listen(port);                   <b class="conum">(4)</b>

    bs.init({                              <b class="conum">(5)</b>
      files: ['./examples'],
      port: PUBLIC_PORT,
      open: false,
      logPrefix: 'nodebook',
      proxy: {
        target: `http://localhost:${port}`,<b class="conum">(6)</b>
        ws: true,
      }
    });
  };
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>On passe un serveur http en argument (obtenu via <code>http.createServer()</code> par exemple) ;</p>
</li>
<li>
<p>Ce port sera assignÃ© au serveur web mais ne sera pas vouÃ© Ã  Ãªtre public ;</p>
</li>
<li>
<p>Ce port, lui, est celui qui sera public ;</p>
</li>
<li>
<p>DÃ©marrage du serveur web sur le port privÃ© ;</p>
</li>
<li>
<p>Initialisation de <em>browser-sync</em> ;</p>
</li>
<li>
<p>InterfaÃ§age avec le serveur web crÃ©Ã© au point 4.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La synchronisation peut Ãªtre activÃ©e avec tous les exemples du chapitre en suffixant la commande <code>npm start</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>nodebook chapter 4
<span data-bash-subs="$"></span>npm start -- --with-sync</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>browser-sync</em></div>
<div class="paragraph">
<p><em>browser-sync</em> est richement documentÃ© et illustrÃ©, y compris ses intÃ©grations avec les outils <em>gulp</em> et <em>grunt</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://browsersync.io/" class="bare">browsersync.io/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/browser-sync" class="bare">npmjs.com/browser-sync</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>browser-sync</em> a beau maintenir la position du <em>scroll</em>, il n&#8217;en reste pas moins que <strong>chaque changement remet Ã  zÃ©ro</strong> l&#8217;espace mÃ©moire de la page.
C&#8217;est lÃ  qu&#8217;entre en jeu le <strong>remplacement des modules Ã  chaud</strong>.</p>
</div>
<div class="paragraph">
<p>Le <strong>remplacement des modules Ã  chaud</strong> (<em>Hot Module Replacement</em> ou <em>HMR</em>) est une technique basÃ©e sur le remplacement de fonctions ou d&#8217;objets tout en assurant le maintien de leurs variables ou Ã©tats internes.
Cette technique a notamment Ã©tÃ© popularisÃ©e par la combinaison de la librairie <em>React</em> et de l&#8217;outil d&#8217;assemblage <em>Webpack</em>.
Il est toutefois possible de procÃ©der Ã  du <em>remplacement Ã  chaud</em> sans <em>React</em> et sans <em>Webpack</em>.</p>
</div>
<div class="paragraph">
<p>Quatre actions sont effectuÃ©es :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>un <strong>serveur de remplacement Ã  chaud</strong> est dÃ©marrÃ© localement ;</p>
</li>
<li>
<p>l&#8217;outil d&#8217;assemblage (<em>browserify</em>, <em>Webpack</em>, etc.) <strong>insÃ¨re du code client</strong> permettant d&#8217;Ã©tablir un lien entre la page web et le serveur de remplacement Ã  chaud ;</p>
</li>
<li>
<p>l&#8217;outil d&#8217;assemblage <strong>dÃ©clare les fichiers modifiÃ©s</strong>, transmis par le serveur de remplacement Ã  chaud vers le navigateur web ;</p>
</li>
<li>
<p>le <strong>code client remplace les modules</strong> et maintient leur Ã©tat interne.</p>
</li>
</ol>
</div>
<div class="videoblock">
<div class="title">Exemple de rechargement Ã  chaud avec des composants <em>React</em>.</div>
<div class="content">
<video src="./videos/react-hmr.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le <em>plugin browserify</em> nommÃ© <em>livereactload</em> est trÃ¨s certainement le plus facile Ã  mettre en place pour remplacer des modules <em>React</em> Ã  la volÃ©e.
Il nÃ©cessite une ligne de configuration cÃ´tÃ© <em>browserify</em> et ne nÃ©cessite aucun changement de code cÃ´tÃ© client.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>livereactload</em></div>
<div class="paragraph">
<p>Des aides Ã  l&#8217;installation du module <em>livereactload</em> sont disponibles dans son fichier README.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/livereactload" class="bare">npmjs.com/livereactload</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le remplacement Ã  chaud n&#8217;est possible que lorsque nous sommes dans un Ã©tat de reconstruction en continu, par exemple avec <a href="#watchify">watchify</a>.</p>
</div>
<div class="paragraph">
<p>Nous pouvons constater les effets du remplacement Ã  chaud avec un des exemples de ce chapitre accessible sur <span class="URL"><a href="http://localhost:4000/examples/livereload/react-app-hmr.html" class="bare">localhost:4000/examples/livereload/react-app-hmr.html</a></span>.
La commande <code>npm run watch</code> de ce chapitre dÃ©marre un serveur web et reconstruit en continu le fichier <code>./examples/livereload/react-app-hmr.js</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>nodebook chapter 4
<span data-bash-subs="$"></span>npm run watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>Qui n&#8217;est autre qu&#8217;un Ã©quivalent de :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>watchify -dv \
  -t babelify \         # <1>
  -p livereactload \    # <2>
  -e ./examples/livereload/react-app-hmr.js \
  -o ./examples/livereload/react-app-hmr-browserify.js</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le <em>transform</em> (<code>-t</code>) modifie le code Ã  la volÃ©e ;</p>
</li>
<li>
<p>Le <em>plugin</em> (<code>-p</code>) encapsule le fonctionnement de <em>watchify</em> pour effectuer des opÃ©rations plus complexes et impossibles Ã  effectuer autrement.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il faudra ensuite modifier l&#8217;un des deux fichiers suivants â en dÃ©commentant les lignes concernÃ©es par exemple â pour constater les changements dans notre navigateur.</p>
</div>
<div class="listingblock">
<div class="title">livereload/react-app-hmr.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { createElement } from 'react';
import ReactDOM from 'react-dom';
import ButtonCount from './button-count.jsx';

ReactDOM.render(
  createElement('div', {}, [
    createElement(ButtonCount),
    createElement(ButtonCount),
    // createElement(ButtonCount),
  ]),
  document.querySelector('#app')
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Chaque instance du composant <code>livereload/button-count.jsx</code> gÃ¨re un Ã©tat interne indÃ©pendant des autres instances de mÃªme type.
Nous aurions perdu cet Ã©tat interne en cas d&#8217;utilisation de <em>browser-sync</em>, sans <em>remplacement Ã  chaud</em> :</p>
</div>
<div class="listingblock">
<div class="title">livereload/button-count.jsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jsx hljs" data-lang="jsx">import React, { Component } from 'react';

export default class ButtonCount extends Component {
  constructor(props) {
    super(props);

    this.handleClick = this.handleClick.bind(this);

    this.state = {
      clickCount: 0                                           <b class="conum">(1)</b>
    };
  }

  handleClick () {
    this.setState({ clickCount: this.state.clickCount + 1 }); <b class="conum">(2)</b>
  }

  render() {
    let style = {};
    // style = {
    //   fontFamily: 'monospace',
    //   fontWeight: 'bold',
    //   textTransform:' uppercase',
    // };

    return (&lt;button style={style} onClick={this.handleClick}&gt;
      Clics : {this.state.clickCount}
    &lt;/button&gt;);
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Initialisation du compteur de clics propre Ã  chaque instance de <code>ButtonCount</code> ;</p>
</li>
<li>
<p>IncrÃ©mentation du compteur de clics en rÃ©action Ã  un clic sur le composant <code>ButtonCount</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>ud</em> et <em>browserify-hmr</em></div>
<div class="paragraph">
<p>Deux modules sont Ã  disposition pour respectivement dÃ©clarer des modules remplaÃ§ables et pour dÃ©marrer un serveur de remplacement Ã  chaud minimaliste.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/ud" class="bare">npmjs.com/ud</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/browserify-hmr" class="bare">npmjs.com/browserify-hmr</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="node-sass">6.3. Modulariser ses feuilles de style avec <em>Sass</em></h3>
<div class="paragraph">
<p>La modularitÃ© et l&#8217;Ã©criture d&#8217;un code isolÃ© facilitent sa rÃ©utilisation et prÃ©viennent les effets de bord.<br>
Dans le cas des feuilles de style CSS, cela peut aider Ã  Ã©viter de faire <em>dÃ©border</em> la cascade â si l&#8217;on peut dire.</p>
</div>
<div class="paragraph">
<p>Avec le <em>langage Sass</em> (<span class="URL"><a href="http://sass-lang.com" class="bare">sass-lang.com</a></span>), nous pourrions songer Ã  gÃ©nÃ©rer des blocs de code selon des <strong>listes</strong> (idÃ©al pour des thÃ¨mes de couleurs, des rubriques produits, etc.), Ã  concevoir des <strong>composants comme des fonctions</strong> ou Ã  bÃ©nÃ©ficier de fonctions de <strong>calcul de couleurs</strong> ou d&#8217;unitÃ©s de mesure.</p>
</div>
<div class="paragraph">
<p>Le langage <em>Sass</em> est originaire du monde Ruby mais il a Ã©tÃ© depuis rendu accessible nativement Ã  l&#8217;Ã©cosystÃ¨me Node par le biais de <em>node-sass</em> (<span class="URL"><a href="https://npmjs.com/node-sass" class="bare">npmjs.com/node-sass</a></span>)â et par extension, par la librairie C <em>libsass</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Lecture</span> CSS maintenables avec Sass et Compass</div>
<div class="paragraph">
<p>Je recommande la lecture de cet ouvrage de rÃ©fÃ©rence Ã©crit par <em>Kaelig Deloumeau-Prigent</em> aux Ã©ditions <em>Eyrolles</em>.
Il dÃ©crit trÃ¨s bien les tenants et aboutissants de Sass ainsi que de bonnes mÃ©thodes d&#8217;organisation du code et de maintenabilitÃ© au sein d&#8217;une Ã©quipe de travail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://editions-eyrolles.com/Livre/9782212136401" class="bare">editions-eyrolles.com/Livre/9782212136401</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>node-sass</em> offre un outil en ligne de commande pour compiler un fichier Sass, plusieurs fichiers Sass ou encore une arborescence de rÃ©pertoires contenant des fichiers Sass vers des fichiers CSS comprÃ©hensibles par les navigateurs web.</p>
</div>
<div class="listingblock">
<div class="title">ui/buttons.scss</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sass hljs" data-lang="sass">$sizes: (                             <b class="conum">(1)</b>
  small: .8,
  regular: 1,
  large: 1.2
);

.btn {
  @each $size, $factor in $sizes {    <b class="conum">(2)</b>
    &amp;.btn--#{$size} {                 <b class="conum">(3)</b>
      font-size: $factor * 1em;       <b class="conum">(4)</b>
    }
  }

  &amp;.btn--icon {                       <b class="conum">(5)</b>
    svg {
      height: 16px;
      width: 16px;
      margin-right: .5em;
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>DÃ©finition d&#8217;une <code>Map</code> nommÃ©e <code>$sizes</code> (ensemble clÃ©/valeur) dÃ©crivant des tailles et leur facteur multiplicateur ;</p>
</li>
<li>
<p>ItÃ©ration et extraction des clÃ©s/valeurs de <code>$sizes</code> ;</p>
</li>
<li>
<p>Interpolation d&#8217;une variable pour composer un sÃ©lecteur CSS (<code>.btn&#8212;&#8203;small</code>, <code>.btn&#8212;&#8203;regular</code> etc.) ;</p>
</li>
<li>
<p>Calcul de la taille de la police de caractÃ¨res (<code>.8em</code>, <code>1em</code> etc.);</p>
</li>
<li>
<p>Composition d&#8217;un sÃ©lecteur de classe Ã  partir du sÃ©lecteur courant (<code>.btn.btn&#8212;&#8203;icon</code>).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La compilation des fichiers s&#8217;effectue trÃ¨s simplement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/node-sass -o ./examples ./examples/buttons.scss</code></pre>
</div>
</div>
<div class="paragraph">
<p>La compilation gÃ©nÃ©rera le fichier CSS <code>button.css</code>, lisible par tout navigateur web :</p>
</div>
<div class="listingblock">
<div class="title">ui/buttons.css</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-css hljs" data-lang="css">.btn.btn--small {
  font-size: 0.8em; }

.btn.btn--regular {
  font-size: 1em; }

.btn.btn--large {
  font-size: 1.2em; }

.btn.btn--icon svg {
  height: 16px;
  width: 16px;
  margin-right: .5em; }</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Oublions les <em>vendor prefix</em></div>
<div class="paragraph">
<p>Les navigateurs Ã©voluent plus vite que le cycle de vie de nos projets.
Certaines propriÃ©tÃ©s CSS sont abritÃ©es derriÃ¨re des prÃ©fixes (<code>-moz</code>, <code>-webkit</code> etc.) avant d&#8217;Ãªtre standardisÃ©es.</p>
</div>
<div class="paragraph">
<p>Ces deux modules nous facilitent la vie en prÃ©fixant et rÃ©Ã©crivant automatiquement les attributs en fonction de nos exigences de compatibilitÃ© navigateurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/autoprefixer" class="bare">npmjs.com/autoprefixer</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/postcss" class="bare">npmjs.com/postcss</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ui-bundling">6.4. Lier composants visuels et feuilles de style</h3>
<div class="paragraph">
<p>Souvenons-nous de la section expliquant le <a href="#react">rapprochement entre donnÃ©es, rendu et interactions avec <em>React</em></a> de ce mÃªme chapitre.
Finalement nous avons presque tout rapprochÃ©, exception faite de la prÃ©sentation avec <em>Sass</em> ou CSS.</p>
</div>
<div class="paragraph">
<p>En suivant la logique de notre approche modulaire, nous pourrions imaginer un <em>transform browserify</em> pour compiler et/ou extraire notre code <em>Sass</em> ou CSS depuis nos composants <em>CommonJS</em> ou <em>ECMAScript 2015</em>.</p>
</div>
<div class="paragraph">
<p>C&#8217;est exactement la proposition du module <em>sassify</em>.
Il intÃ¨gre <em>node-sass</em> en tant que <em>transform browserify</em> et le transforme le code Ã  la volÃ©e durant la phase de compilation.
Il se charge lui-mÃªme d&#8217;ajouter les styles dans le document HTML ou expose le code CSS compilÃ© via la fonction <code>require()</code>.</p>
</div>
<div class="paragraph">
<p>Une saine stratÃ©gie serait de charger des CSS de base dans une feuille de style en tÃªte de <code>&lt;head&gt;</code> puis de laisser les composants graphiques injecter leurs feuilles CSS respectives aprÃ¨s coup.</p>
</div>
<div class="paragraph">
<p>L&#8217;exemple suivant expose deux composants <em>React</em>, regroupÃ©s dans une thÃ©matique de composants de boutons HTML.
Une feuille de style est importÃ©e Ã  mÃªme le module afin de <strong>gÃ©rer Ã  un mÃªme niveau, prÃ©sentation, rendu et interactions</strong> :</p>
</div>
<div class="listingblock">
<div class="title">ui/Buttons.jsx</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jsx hljs" data-lang="jsx">import React from 'react';
import './buttons.scss';

const Icon = (props) =&gt; (&lt;svg aria-hidden="true"&gt;
  &lt;use xlinkHref={'symbols.svg#' + props.id} /&gt;
&lt;/svg&gt;);

export const BaseButton = (props) =&gt; (
  &lt;button className={'btn btn--' + props.variant}&gt;{props.children}&lt;/button&gt;
);

export const IconButton = (props) =&gt; (
  &lt;button className="btn btn--icon"&gt;
    &lt;Icon id={props.icon} /&gt;
    {props.children}
  &lt;/button&gt;
);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import d&#8217;un fichier <em>Sass</em> qui sera par la suite compilÃ© en CSS par le <em>transform sassify</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sans surprise, le module <em>sassify</em> se charge comme la majoritÃ© des <em>transform browserify</em> comme vu dans la section <a href="#browserify">Importer des modules npm pour le web</a> dans ce mÃªme chapitre :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t sassify \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante injectera automatiquement les feuilles de style compilÃ©es dans le document HTML lors de son exÃ©cution dans un navigateur web :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/browserify \
  -t [ sassify --auto-inject ] \
  -t babelify \
  -e ./examples/Buttons.jsx \
  -o ./examples/Button-browserify.js</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> CSS Modules</div>
<div class="paragraph">
<p>Une autre philosophie Ã©mergente est de continuer Ã  transformer son code <em>Sass</em> ou CSS en styles en ligne, Ã  leur adjoindre un prÃ©fixe unique et Ã  les insÃ©rer directement dans le code HTML.<br>
Elle demande moins d&#8217;outillage et s&#8217;applique pleinement Ã  des composants visuels modulaires :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/css-modules" class="bare">npmjs.com/css-modules</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://npmjs.com/css-modulesify" class="bare">npmjs.com/css-modulesify</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="optimiser_ses_ressources_graphiques">6.5. Optimiser ses ressources graphiques</h3>
<div class="paragraph">
<p>Node est un outil de choix lorsque l&#8217;on souhaite s&#8217;atteler au dÃ©veloppement <em>frontend</em> et ce n&#8217;est pas sans raison.
Outre l&#8217;outillage liÃ© Ã  la rÃ©Ã©criture du code â comme <a href="#babel">Babel</a> et <a href="#browserify">browserify</a> Ã©voquÃ©s ci-avant â Node regorge de modules <em>npm</em> rÃ©duisant les tÃ¢ches manuelles rÃ©pÃ©titives et possiblement sujettes Ã  erreur.</p>
</div>
<div class="paragraph">
<p>Nous retrouvons l'<strong>optimisation des ressources graphiques</strong> parmi cet ensemble de tÃ¢ches rÃ©barbatives.
Quand j&#8217;Ã©cris <em>ressources graphiques</em>, j&#8217;entends par lÃ  le redimensionnement ou la crÃ©ation de vignettes d&#8217;images, l&#8217;optimisation de leur poids, la fusion de fichiers SVG sous forme de symboles, la crÃ©ation de piles de polices de caractÃ¨re et mÃªme l&#8217;encodage audio/vidÃ©o â via des <em>bindings</em> avec des logiciels spÃ©cialisÃ©s comme <em>ffmpeg</em> ou <em>lame</em>.</p>
</div>
<div class="paragraph">
<p>L&#8217;outil en ligne de commande <em>imagemin-cli</em> (<span class="URL"><a href="https://npmjs.com/imagemin-cli" class="bare">npmjs.com/imagemin-cli</a></span>) est le module de rÃ©fÃ©rence pour optimiser les fichiers graphiques.
Il est basÃ© sur la librairie <em>imagemin</em> (<span class="URL"><a href="https://npmjs.com/imagemin" class="bare">npmjs.com/imagemin</a></span>) et se chargera de rÃ©duire le poids de nos images JPEG, PNG mais aussi GIF (animÃ©s et statiques) ainsi que le format vectoriel SVG.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/imagemin images/* --out-dir images
8 images minified</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Glossaire</span> Compression destructive et non-destructive</div>
<div class="paragraph">
<p>Il existe deux types de compression : avec et sans perte (<em>lossless</em>).
Elles ont toutes deux des caractÃ©ristiques distinctes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>destructive</strong> : poids rÃ©duit au maximum, possibles artÃ©facts visuels, destruction potentielle de couleurs dans le cas d&#8217;images complexes ;</p>
</li>
<li>
<p><strong>sans perte</strong> : poids rÃ©duit, les couleurs supprimÃ©es ne sont pas perceptibles Ã  l&#8217;Åil nu.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il vaut mieux privilÃ©gier la <em>compression sans perte</em> pour Ã©viter les artÃ©facts visuels et respecter fidÃ¨lement la crÃ©ation d&#8217;origine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le <strong>redimensionnement d&#8217;images</strong> est une autre de ces tÃ¢ches courantes et rÃ©currentes qui tombe rapidement aux oubliettes de par sa gourmandise en temps.
On voudra par exemple redimensionner des photos depuis des fichiers originaux, gÃ©nÃ©rer des <strong>vignettes</strong> ou encore <strong>gÃ©nÃ©rer diffÃ©rentes tailles d&#8217;images</strong> adaptÃ©es aux diffÃ©rentes dispositions d&#8217;un site web <em>responsive</em>.</p>
</div>
<div class="paragraph">
<p><em>sharp-cli</em> (<span class="URL"><a href="https://npmjs.com/sharp-cli" class="bare">npmjs.com/sharp-cli</a></span>) rÃ©pond exactement Ã  ce cahier des charges.
Ce module en ligne de commande est basÃ© sur <em>sharp</em> (<span class="URL"><a href="https://npmjs.com/sharp" class="bare">npmjs.com/sharp</a></span>), une librairie Node de modification d&#8217;images Ã©crite en <em>ECMAScript</em> et <em>C++</em>.
<em>sharp</em> nous aidera entre autres Ã  redimensionner, dÃ©couper, retourner, recentrer, assembler et appliquer des effets graphiques de maniÃ¨re prÃ©dictible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/sharp resize 500 \
  --min \
  -i images/*.png \
  --output ./images/thumbs</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande prÃ©cÃ©dente illustre une <strong>opÃ©ration de redimensionnement d&#8217;images</strong> :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>d&#8217;une dimension de <strong>500 pixels de largeur</strong> ;</p>
</li>
<li>
<p><strong>minimum</strong> (donc respecte) â sans cet attribut les images seraient des carrÃ©s de 500 pixels de large et de 500 pixels de haut ;</p>
</li>
<li>
<p>ciblant toutes les <strong>images PNG</strong> du rÃ©pertoire <code>images</code> ;</p>
</li>
<li>
<p>puis <strong>exportÃ©es dans le rÃ©pertoire</strong> <code>images/thumbs</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/sharp grayscale \
  -i images/*.png \
  --output ./images/square</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ã l&#8217;inverse, la commande prÃ©cÃ©dente illustre la conversion en noir et blanc d&#8217;images ainsi que leur export dans un rÃ©pertoire diffÃ©rent.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface en ligne de commande de <em>sharp-cli</em> ne permet pas de crÃ©er d&#8217;opÃ©rations composites (redimensionner et convertir en niveaux de gris par exemple).
Il faudra recourir Ã  l&#8217;API Node de <em>sharp</em> et chaÃ®ner les opÃ©rations en s&#8217;aidant des exemples documentÃ©s sur <span class="URL"><a href="http://sharp.dimens.io/" class="bare">sharp.dimens.io/</a></span>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> gm</div>
<div class="paragraph">
<p>Le module <em>gm</em> est le module <em>classique</em> de redimensionnement dans l&#8217;Ã©cosystÃ¨me Node.
Il s&#8217;interface avec le programme <em>GraphicsMagick</em> et <em>ImageMagick</em> â et nÃ©cessite donc leur prÃ©sence sur le systÃ¨me d&#8217;exploitation.
Cela rend l&#8217;utilisation de <em>gm</em> lÃ©gÃ¨rement moins triviale que celle de <em>sharp</em> mais la quantitÃ© de ressources et la qualitÃ© du module en font une bonne alternative Ã  considÃ©rer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/gm" class="bare">npmjs.com/gm</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://aheckmann.github.io/gm/" class="bare">aheckmann.github.io/gm/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation d&#8217;un <a href="../chapter-05/index.html#npm-scripts">script npm</a> (cf. Chapitre 5) est idÃ©ale pour dÃ©crire les diffÃ©rentes actions d&#8217;optimisation.
Les <em>scripts</em> sont alors Ã  invoquer manuellement, sur un <em>crochet git</em> (<em>git hook</em>) ou automatiquement lors du dÃ©ploiement avec un <a href="../chapter-06/index.html#automated-deploy">service d&#8217;intÃ©gration continue</a>, par exemple.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">7. Tester son code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est bien connu que lorsqu&#8217;on produit du code de qualitÃ©, Ã©crire des tests est amplement superflu et ne sert qu&#8217;Ã  nous ralentir.</p>
</div>
<div class="paragraph">
<p>La rÃ©alitÃ© est toute autre et suit un paradigme trÃ¨s simple : <strong>plus il y a de lignes de code, plus il y a de chances de faire des erreurs</strong>.
Cela vaut aussi bien pour du HTML que du CSS ou encore de l'<em>ECMAScript</em>.</p>
</div>
<div class="paragraph">
<p>Cette ultime et derniÃ¨re section de ce chapitre nous aidera Ã  comprendre quoi et comment tester pour <strong>diminuer le coÃ»t de maintenance de nos applications</strong>.</p>
</div>
<div class="sect2">
<h3 id="testing-101">7.1. Que tester ?</h3>
<div class="paragraph">
<p>L&#8217;idÃ©e d&#8217;Ã©crire des tests pour amÃ©liorer la qualitÃ© de son code est attrayante mais quand on en sait pas quoi tester et ni Ã  qui demander pour se lancer, il est Ã©vident qu&#8217;on ne va pas s&#8217;y mettre pour s&#8217;assurer que 1+1 valent bien <span class="line-through">3</span> 2.</p>
</div>
<div class="paragraph">
<p>Je pense Ã  ces <em>trois rÃ¨gles</em> lorsque je souhaite Ã©crire des tests :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>qu&#8217;est-ce qui est <strong>public/exportÃ©</strong> ?</p>
</li>
<li>
<p>qu&#8217;est-ce qui crÃ©e des <strong>branches dans mon code</strong> ?</p>
</li>
<li>
<p>qu&#8217;est-ce qui <strong>vient du monde extÃ©rieur</strong> ?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La syntaxe de modules <em>ECMAScript 2015</em> est idÃ©ale pour visualiser les segments de code qui sont exportÃ©s par nos diffÃ©rents fichiers.
ÃlÃ©ment marquant : ce code est simple et devrait arriver Ã  compter le nombre de mots mais nous n&#8217;avons aucune idÃ©e s&#8217;il fera correctement le travail sans l&#8217;exÃ©cuter dans une application.</p>
</div>
<div class="listingblock">
<div class="title">test-export.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const isWord = (word) =&gt; {
  return /^[\w\s.,\-?!;+]{2,}$/.test(word) &amp;&amp; Number.isNaN(Number(word));
};

export default function countWords (sentence) { <b class="conum">(1)</b>
  return sentence
    .split(' ')
    .filter(isWord)
    .length;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La fonction <code>countWords</code> le seul Ã©lÃ©ment exportÃ© par notre module et devrait donc Ãªtre le seul sujet de nos tests.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Une <em>branche</em> est une portion de <strong>code qui s&#8217;exÃ©cute de maniÃ¨re ponctuelle</strong>.
Ces sections de code s&#8217;activent ou non selon l&#8217;Ã©tat d&#8217;une structure de donnÃ©es.
Il faut <strong>prÃ©voir <em>au moins autant</em> de tests que de branches</strong> pour valider les attentes.</p>
</div>
<div class="listingblock">
<div class="title">test-branches.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">export default function isOdd (number) {
  if (typeof number !== 'number' || Number.isNaN(number)) { <b class="conum">(1)</b>
    throw new Error('number devrait Ãªtre un nombre')
  }

  if (number % 2) { <b class="conum">(2)</b>
    return true;
  }
  else {            <b class="conum">(3)</b>
    return false;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>PremiÃ¨re branche activÃ©e dans <em>deux</em> cas de figure ;</p>
</li>
<li>
<p>Seconde branche ;</p>
</li>
<li>
<p>TroisiÃ¨me branche.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Enfin, l'<strong>accÃ¨s Ã  toute donnÃ©e externe</strong> est susceptible de mal fonctionner sans que nous puissions maitriser l&#8217;origine des problÃ¨mes.
En revanche l&#8217;Ã©criture de tests nous aidera Ã  <strong>accepter ce cas de figure</strong> et Ã  le signaler Ã  nos applications.</p>
</div>
<div class="listingblock">
<div class="title">test-outside-world.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">export default function getLinkElementContent (linkElement) {
  const {href} = linkElement;           <b class="conum">(1)</b>

  return fetch(href)                    <b class="conum">(2)</b>
    .then(response =&gt; response.json())  <b class="conum">(3)</b>
    .then(pkg =&gt; pkg.dependencies);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>linkElement</code> peut ne pas Ãªtre un lien hypertexte (<code>document.querySelector</code> retourne <code>null</code>) ;</p>
</li>
<li>
<p>Ici tout peut arriver : <code>href</code> n&#8217;est pas une URL valide (balise <code>href</code> vide), serveur indisponible etc ;</p>
</li>
<li>
<p>Et lÃ , le fichier JSON peut Ãªtre mal formÃ© ou la rÃ©ponse est exprimÃ©e dans un autre format que JSON.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous savons dÃ©sormais Ã  peu prÃ¨s tout ce qu&#8217;il faut <em>flairer</em> pour renforcer nos applications en Ã©crivant quelques tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="s_outiller_pour_Ã©crire_des_assertions">7.2. S&#8217;outiller pour Ã©crire des assertions</h3>
<div class="paragraph">
<p>Avant de nous lancer directement dans la conception et l&#8217;Ã©criture des tests, intÃ©ressons-nous Ã  comprendre comment l&#8217;outillage se structure.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>l'<strong>assertion</strong><br>
C&#8217;est la <em>vÃ©rification</em> d&#8217;une vÃ©ritÃ©, d&#8217;une attente, du rÃ©sultat d&#8217;une opÃ©ration.
Une <em>assertion</em> couvre <em>une branche</em> de code.</p>
</li>
<li>
<p>le <strong>test</strong><br>
C&#8217;est un <em>regroupement d&#8217;assertions</em> couvrant toutes les <em>branches</em> des fonctionnalitÃ©s <em>publiques</em> de notre code.</p>
</li>
<li>
<p>la <strong>suite de tests</strong><br>
C&#8217;est un <em>ensemble de tests</em> couvrant un aspect logique d&#8217;un code applicatif.
Une application peut comporter plusieurs suites selon sa complexitÃ© :</p>
<div class="ulist">
<ul>
<li>
<p>tests <strong>unitaires</strong> pour s&#8217;assurer du fonctionnement de l&#8217;interface de code ;</p>
</li>
<li>
<p>tests <strong>fonctionnels</strong> pour s&#8217;assurer du fonctionnement de scÃ©narios d&#8217;utilisation d&#8217;une application ;</p>
</li>
<li>
<p>tests d'<strong>intÃ©gration</strong> pour s&#8217;assurer du fonctionnement d&#8217;une application en relation avec d&#8217;autres applications lui fournissant donnÃ©es et services ;</p>
</li>
</ul>
</div>
</li>
<li>
<p>l'<strong>exÃ©cuteur de tests</strong><br>
C&#8217;est le logiciel responsable de crÃ©er l&#8217;environnement d&#8217;exÃ©cution d&#8217;une <em>suite de tests</em>.
Ils expriment une opinion sur la structuration des tests ainsi que sur des automatismes Ã  fournir pour accÃ©lÃ©rer l&#8217;Ã©criture des tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;outillage varie selon chacun de ces niveaux.
Certains outils offrent une Ã©criture d&#8217;assertion plus fluide, d&#8217;autres proposent une Ã©criture plus spÃ©cifiquement adaptÃ©e.</p>
</div>
<div class="paragraph">
<p>Les sections suivantes sont complÃ©mentaires.
J&#8217;ai favorisÃ© des approches itÃ©ratives et modulaires pour faciliter l&#8217;ajout ou le retrait de tout outil de notre outillage :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la librairie <em>chai</em> pour les <em>assertions</em> ;</p>
</li>
<li>
<p>la librairie <em>mocha</em> pour les <em>tests</em> ;</p>
</li>
<li>
<p>la librairie <em>mocha</em> pour la <em>suite de tests</em> exÃ©cutable par Node ;</p>
</li>
<li>
<p>l'<em>exÃ©cuteur de tests</em> nommÃ©  <em>karma</em> pour faire fonctionner la <em>suite de tests</em> dans les navigateurs web.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>chai</em>, <em>mocha</em> et <em>karma</em></div>
<div class="paragraph">
<p>Ces trois librairies disposent d&#8217;une documentation en ligne expliquant leurs options respectives ainsi que des exemples d&#8217;utilisation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://chaijs.com/api/bdd/" class="bare">chaijs.com/api/bdd/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://mochajs.org/" class="bare">mochajs.org/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://karma-runner.github.io/" class="bare">karma-runner.github.io/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock interactive interactive--javascript">
<div class="title">Exemple d&#8217;assertion avec la librairie <em>chai</em></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import {expect} from 'chai';

expect(2+2).to.equal(4);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple de test avec la librairie <em>mocha</em></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">describe('functionName', () =&gt; {
  it('should succeed with parameter cheese', () =&gt; {
    // ...
  });

  it('should throw an error with parameter meat', () =&gt; {
    // ...
  });
});</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Exemple d&#8217;exÃ©cution de suites de tests avec <em>mocha</em> et <em>karma</em></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>mocha tests/**/*.js
<span data-bash-subs="$"></span>karma start</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;exÃ©cuteur de tests <em>karma</em> se configure par le biais d&#8217;un fichier <code>karma.conf.js</code>.
Nous en trouverons un Ã  la racine du rÃ©pertoire des ressources de ce chapitre 4.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_ses_composants_react_sans_navigateur_web">7.3. Tester ses composants React sans navigateur web</h3>
<div class="paragraph">
<p>Un des points forts de <a href="#react">React</a> Ã©voquÃ© dans ce chapitre est la <em>description de son rendu</em> Ã  mÃªme le composant.
Nous bÃ©nÃ©ficions ainsi du rÃ©sultat final (son HTML par exemple) ainsi que d&#8217;un arbre reprÃ©sentant une structure de sous-Ã©lÃ©ments et de propriÃ©tÃ©s.</p>
</div>
<div class="paragraph">
<p>Nous disposons de deux stratÃ©gies pour tester un composant <em>React</em> afin d&#8217;en tester les diffÃ©rents comportements :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>tester le rendu</strong> en comparant des chaÃ®nes de caractÃ¨res ;</p>
</li>
<li>
<p><strong>tester l&#8217;Ã©tat</strong> en validant la prÃ©sence d&#8217;attributs ou le dÃ©clenchement de certaines mÃ©thodes du composant.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La librairie <em>Enzyme</em> (<span class="URL"><a href="https://npmjs.com/enzyme" class="bare">npmjs.com/enzyme</a></span>) s&#8217;occupe trÃ¨s bien des deux, en plus de s&#8217;intÃ©grer avec n&#8217;importe quelle librairie de tests.
Dans tous les cas, elle nous permettra de monter nos composants soit de maniÃ¨re isolÃ©e, soit dans un vÃ©ritable arbre DOM soit en rendu HTML.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>Enzyme</em></div>
<div class="paragraph">
<p>L&#8217;Ã©quipe d&#8217;Airbnb offre une documentation exhaustive ainsi que des exemples complets d&#8217;intÃ©gration avec des outils comme <em>mocha</em>, <em>webpack</em>, <em>tape</em> ou encore <em>ava</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="http://airbnb.io/enzyme/" class="bare">airbnb.io/enzyme/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="http://airbnb.io/enzyme/docs/api/" class="bare">airbnb.io/enzyme/docs/api/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Nous allons nous baser sur le composant crÃ©Ã© dans la section <a href="#react">rapprocher donnÃ©es, rendu et interactions avec React</a> pour s&#8217;assurer de son comportement <em>avant mÃªme de l&#8217;inclure</em> dans notre application.</p>
</div>
<div class="listingblock">
<div class="title">tests/date-interval.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { createElement } from 'react';
import { expect } from 'chai';
import { shallow } from 'enzyme';
import DateInterval from '../modules/date-interval.jsx';    <b class="conum">(1)</b>

describe('&lt;DateInterval /&gt;', () =&gt; {
  it('should render a time element', () =&gt; {                <b class="conum">(2)</b>
    const component = shallow(createElement(DateInterval)); <b class="conum">(3)</b>

    expect(component.find('time')).to.have.length(1);       <b class="conum">(4)</b>
  });

  it('should populate props.tickData with now+className properties', () =&gt; {
    const component = shallow(createElement(DateInterval)); <b class="conum">(5)</b>
    const {tickData} = component.state();                   <b class="conum">(6)</b>

    expect(tickData.now.getTime()).to.be.closeTo(Date.now(), 3);  <b class="conum">(7)</b>
    expect(tickData.className).to.be.oneOf(['pair', 'impair']);   <b class="conum">(8)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Import du module <code>DateInterval</code> ;</p>
</li>
<li>
<p>CrÃ©ation d&#8217;un <em>test</em> destinÃ© Ã  vÃ©rifier la nature de la balise HTML Ã  gÃ©nÃ©rer ;</p>
</li>
<li>
<p>CrÃ©ation du composant isolÃ© (<em>shallow</em>) â aucun Ã©lÃ©ment DOM ne sera crÃ©Ã© ni insÃ©rÃ© dans le document ;</p>
</li>
<li>
<p>On Ã©crit une <em>assertion</em> garantissant que l&#8217;on retourne un Ã©lÃ©ment <code>&lt;time&gt;</code> ;</p>
</li>
<li>
<p>CrÃ©ation d&#8217;un second composant isolÃ© dont l&#8217;Ã©tat est indÃ©pendant du premier ;</p>
</li>
<li>
<p>RÃ©cupÃ©ration de l&#8217;Ã©tat (<em>state</em>) du composant ;</p>
</li>
<li>
<p>Assertion vÃ©rifiant que la date utilisÃ©e par le composant est proche de la date courante (Ã  quelques millisecondes prÃ¨s);</p>
</li>
<li>
<p>Assertion vÃ©rifiant qu&#8217;une propriÃ©tÃ© de l&#8217;Ã©tat ne peut Ãªtre qu&#8217;une des deux valeurs parmi <code>pair</code> et <code>impair</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>En complÃ©ment Ã  ceci, la librairie <em>chai-enzyme</em> (<span class="URL"><a href="https://npmjs.com/chai-enzyme" class="bare">npmjs.com/chai-enzyme</a></span>) Ã©tend le vocabulaire de <em>chai</em> pour ajouter des assertions de composants.
C&#8217;est une question de goÃ»t plus qu&#8217;une nÃ©cessitÃ©.<br>
L&#8217;exemple suivant reprend le composant crÃ©Ã© dans la section <a href="#livereload">changements en temps-rÃ©el dans le navigateur</a> et illustre une assertion suite Ã  un clic sur le bouton :</p>
</div>
<div class="listingblock">
<div class="title">tests/button-count.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import React from 'react';
import chai, { expect } from 'chai';
import chaiEnzyme from 'chai-enzyme';
import { shallow } from 'enzyme';
import ButtonCount from '../livereload/button-count.jsx';

chai.use(chaiEnzyme());

describe('&lt;ButtonCount /&gt;', () =&gt; {
  it('should increment state on click', () =&gt; {       <b class="conum">(1)</b>
    const component = shallow(&lt;ButtonCount /&gt;);
    component.simulate('click');                      <b class="conum">(2)</b>

    expect(component).to.have.state('clickCount', 1); <b class="conum">(3)</b>
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Le libellÃ© du test dÃ©crit le rÃ©sultat attendu dans les assertions ;</p>
</li>
<li>
<p>Simulation du clic sur le composant ;</p>
</li>
<li>
<p>L&#8217;Ã©tat interne a bien Ã©tÃ© changÃ© et correspond Ã  la valeur attendue.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le fichier <code>package.json</code> des ressources du chapitre 4 contient une tÃ¢che exÃ©cutant les tests exÃ©cutables dans un environnement Node uniquement.
Elle se lance de la maniÃ¨re suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run test:node</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="./images/mocha-react.png" alt="mocha react" width="80%">
</div>
<div class="title">Figure 7. Extrait de la sortie de la commande <code>npm run test:node</code></div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>jest</em></div>
<div class="paragraph">
<p><em>jest</em> est un exÃ©cuteur de tests moderne et rapide particuliÃ¨rement adaptÃ© au test de composants cÃ´tÃ© serveur.
Au moment d&#8217;Ã©crire cet ouvrage, il n&#8217;Ã©tait pas encore possible de l&#8217;exÃ©cuter dans un navigateur web.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://npmjs.com/jest" class="bare">npmjs.com/jest</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://facebook.github.io/jest/" class="bare">facebook.github.io/jest/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il est intÃ©ressant de retenir que les tests navigateurs ne sont pas indispensables pour s&#8217;assurer du bon fonctionnement de nos composants.
Des librairies comme <em>React</em> sont dÃ©jÃ  solidement testÃ©es.
Cela nous laisse l&#8217;opportunitÃ© de nous concentrer uniquement sur notre logique mÃ©tier.</p>
</div>
<div class="paragraph">
<p>Les tests navigateurs sont en revanche utiles pour tester la compatibilitÃ© navigateurs, que ce soit au niveau de la syntaxe <em>ECMAScript</em> ou du rendu CSS.</p>
</div>
</div>
<div class="sect2">
<h3 id="tester_code_et_composants_dans_les_navigateurs_web">7.4. Tester code et composants dans les navigateurs web</h3>
<div class="paragraph">
<p>C&#8217;est bien beau de tester uniquement l&#8217;interface de composants <em>React</em> (ou autre technologie) mais comment faire lorsqu&#8217;on a besoin de tester avec un vrai DOM ou dans plusieurs navigateurs web ?</p>
</div>
<div class="paragraph">
<p>On a besoin de tester dans un ou plusieurs navigateurs web pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>s&#8217;assurer de la <strong>compatibilitÃ© de notre code</strong> avec les variations d&#8217;implÃ©mentation de navigateurs web ;</p>
</li>
<li>
<p>valider notre choix de <em>polyfills</em> ;</p>
</li>
<li>
<p><strong>tester fidÃ¨lement</strong> contre des APIs de navigateurs ou du DOM (comme <em>Web Audio</em>, <em>Service Workers</em>, etc.).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Autrement dit, nous avons besoin d&#8217;un <strong>exÃ©cuteur de tests</strong> qui les fasse fonctionner dans l&#8217;environnement d&#8217;un navigateur web.
IdÃ©alement, nous voulons que cet <em>exÃ©cuteur de tests</em> n&#8217;influent pas sur l&#8217;outillage employÃ© pour Ã©crire nos tests et donc nous permette d&#8217;utiliser <em>mocha</em> et <em>chai</em> comme dans la section prÃ©cÃ©dente.</p>
</div>
<div class="paragraph">
<p><em>karma</em> (<span class="URL"><a href="https://npmjs.com/karma" class="bare">npmjs.com/karma</a></span>) est l&#8217;outil phare de l&#8217;Ã©cosystÃ¨me Node dÃ©diÃ© aux tests dans les navigateurs web.
Il a Ã©tÃ© crÃ©Ã© en 2012 pour faciliter l&#8217;exÃ©cution des suites de tests de la librairie <em>Angular</em> et s&#8217;exÃ©cute en <strong>ligne de commande</strong>, assez simplement.</p>
</div>
<div class="paragraph">
<p>Les fonctionnalitÃ©s de <em>karma</em> s&#8217;Ã©tendent Ã  l&#8217;aide de modules <em>npm</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>intÃ©grations</strong> avec des <em>suites de tests</em> ;</p>
</li>
<li>
<p><strong>lanceurs</strong> de navigateurs web ;</p>
</li>
<li>
<p><strong>prÃ©processeurs</strong> pour transformer des fichiers, les servir et/ou les inclure dans l&#8217;environnement de tests.</p>
</li>
</ul>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em>.</div>
<div class="content">
<video src="./videos/karma-browsers.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Le pilotage de <em>karma</em> se fait via un fichier de configuration <code>karma.conf.js</code>.
Il est possible de surcharger ultÃ©rieurement cette configuration avec des arguments de la ligne de commande.</p>
</div>
<div class="listingblock">
<div class="title">Initialisation automatique d&#8217;un fichier de configuration <code>karma.conf.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>./node_modules/.bin/karma init</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> fonctionne avec des navigateurs installÃ©s sur notre machine de dÃ©veloppement tout comme avec des services distants comme <em>SauceLabs</em> ou <em>BrowserStack</em> (voir <a href="#ci">intÃ©gration continue et compatibilitÃ© navigateurs</a>).
Les navigateurs doivent dÃ©jÃ  Ãªtre disponibles sur la machine de test (Firefox et Chrome par exemple) et nous devons en parallÃ¨le installer les <strong>lanceurs</strong> (<code>karma-firefox-launcher</code> et <code>karma-chrome-launcher</code> respectivement).</p>
</div>
<div class="paragraph">
<p>Les navigateurs lancÃ©s par dÃ©faut lors des tests sont listÃ©s dans l&#8217;option <code>browsers</code> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L82</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">browsers: ['Chrome'],</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>karma</em> se charge d'<strong>inclure les fichiers JavaScript</strong> ou de <strong>servir des fichiers statiques</strong> en fonction de <em>motifs</em> de chemins.
Ces fichiers peuvent Ãªtre locaux (de prÃ©fÃ©rence) ou distants et mÃªme Ãªtre de types diffÃ©rents comme JSON ou HTML :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L17-23</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">files: [
  //'https://cdn.polyfill.io/v2/polyfill.min.js',           <b class="conum">(1)</b>
  'examples/tests-browser/**/*.js',                         <b class="conum">(2)</b>
  'examples/tests/**/*.js',
  'examples/tests-browser/**/*.html',                       <b class="conum">(3)</b>
  { pattern: 'package.json', served: true, included: false }<b class="conum">(4)</b>
],</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Il suffirait de dÃ©commenter cette ligne pour inclure les <a href="#polyfills"><em>polyfills</em> de navigateurs web</a> sans toucher Ã  notre code ;</p>
</li>
<li>
<p>Inclusion des fichiers de tests spÃ©cifiques aux navigateurs web ;</p>
</li>
<li>
<p>Inclusion de fichiers HTML, sans effet Ã  moins ;</p>
</li>
<li>
<p>Mise Ã  disposition du fichier <code>package.json</code>, accessible via une requÃªte HTTP vers <code>/base/package.json</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Des <em>intÃ©grations</em> doivent Ãªtre dÃ©clarÃ©s pour augmenter les fonctionnalitÃ©s de base de <em>karma</em>.
Les fonctionnalitÃ©s de base de <em>karma</em> se rÃ©sument Ã  charger des fichiers <em>ECMAScript</em> dans une balise <code>&lt;script&gt;</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;extrait de configuration suivant illustre le chargement des <em>plugins</em> pour <em>browserify</em> (modules <em>CommonJS</em> et transpilation), <em>mocha</em> (<em>suites de tests</em>) et <em>fixture</em> (donnÃ©es reprÃ©sentant des cas d&#8217;utilisation) â respectivement les modules <em>npm</em> <code>karma-browserify</code>, <code>karma-mocha</code> et <code>karma-fixture</code> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L13</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">frameworks: ['browserify', 'mocha', 'fixture'],</code></pre>
</div>
</div>
<div class="paragraph">
<p>Une fois encore des <em>motifs de chemins</em> sont utilisÃ©s pour indiquer aux <em>plugins</em> leur responsabilitÃ© de prise en charge.</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L33-37</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">preprocessors: {
  'examples/tests/**/*.js': ['browserify'],                 <b class="conum">(1)</b>
  'examples/tests-browser/**/*.js': ['browserify'],
  'examples/tests-browser/**/*.html': ['html2js'],          <b class="conum">(2)</b>
},</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ces fichiers seront transpilÃ©s par <em>browserify</em> avant d&#8217;Ãªtre chargÃ©s dans les tests de navigateurs web ;</p>
</li>
<li>
<p>Ces fichiers seront pris en charge par le <em>prÃ©processeur</em> nommÃ© <em>html2js</em>, utilisÃ© par <code>karma-fixture</code> pour transformer du HTML en arbre DOM.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Nous avons vu un exemple de code reposant sur un Ã©lÃ©ment du DOM dans la section <a href="#testing-101">que tester ?</a> de ce chapitre.
Nous allons nous intÃ©resser Ã  une maniÃ¨re possible de tester la fonction exportÃ©e <code>getLinkElementContent</code> en se basant sur un <strong>vÃ©ritable appel HTTP</strong> et un <strong>vÃ©ritable Ã©lÃ©ment du DOM</strong>, crÃ©Ã© Ã  partir du fichier de <em>fixture</em> suivant :</p>
</div>
<div class="listingblock">
<div class="title">tests-browser/fixtures/link-package.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;a href="/base/package.json"&gt;Test&lt;/a&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce fichier de <em>fixture</em> est chargÃ© dans le DOM par le <em>plugin</em> <code>karma-fixture</code> pour prouver que l&#8217;on peut rÃ©cupÃ©rer les dÃ©pendances exposÃ©es par le fichier <code>package.json</code> des ressources de ce chapitre :</p>
</div>
<div class="listingblock">
<div class="title">tests-browser/test-outside-world.js</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">import { expect } from 'chai';
import getLinkElementContent from '../test-outside-world.js';

describe('getLinkElementContent', () =&gt; {
  before(() =&gt; fixture.setBase('examples/tests-browser/fixtures')); <b class="conum">(1)</b>

  it('follows an HTML link to a package.json and get its dependencies', () =&gt; {
    const [link] = fixture.load('link-package.html');               <b class="conum">(2)</b>

    return getLinkElementContent(link).then(deps =&gt; {               <b class="conum">(3)</b>
      expect(deps).to.contain.all.keys('babel', 'react', 'enzyme'); <b class="conum">(4)</b>
    });
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>before()</code> indique Ã  <em>mocha</em> d&#8217;exÃ©cuter ce bloc de code avant tout <em>test</em> ;</p>
</li>
<li>
<p>Appel du <em>plugin</em> de <em>fixture</em> pour obtenir l&#8217;Ã©lÃ©ment du DOM nÃ©cessaire Ã  la fonction <code>getLinkElementContent</code> ;</p>
</li>
<li>
<p>Appel rÃ©el de la fonction <code>getLinkElementContent</code>, rÃ©solu comme une <a href="../chapter-03/index.html#promise">promesse</a> et dont nous testons le rÃ©sultat Ã  la ligne suivante ;</p>
</li>
<li>
<p><em>Assertion</em> vÃ©rifiant que le rÃ©sultat contient bien des clÃ©s de dÃ©pendances <em>npm</em> attendues â nous avons bien rÃ©cupÃ©rÃ© le bon fichier et le bon contenu !</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>L&#8217;invocation de <em>karma</em> se fait en invoquant <code>./node_modules/.bin/karma start</code>.
Par mesure de simplicitÃ©, cette commande a Ã©tÃ© abstraite en tant que <a href="../chapter-05/index.html#npm-scripts">script <em>npm</em></a> :</p>
</div>
<div class="listingblock">
<div class="title">ExÃ©cution ponctuelle de <em>karma</em>.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run test:browser</code></pre>
</div>
</div>
<div class="paragraph">
<p>Les tests peuvent Ãªtre relancÃ©s en continu â dÃ¨s qu&#8217;un fichier change â en dÃ©sactivant l&#8217;exÃ©cution unique (<em>single run</em>).
C&#8217;est idÃ©al lorsque les tests sont Ã©crits en parallÃ¨le de l&#8217;implÃ©mentation du code ou que des ajustements frÃ©quents ont lieu en phase de dÃ©veloppement :</p>
</div>
<div class="listingblock">
<div class="title">ExÃ©cution continue de <em>karma</em>.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>npm run test:browser -- --no-single-run</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme tout process de longue durÃ©e, il s&#8217;interrompt Ã  l&#8217;aide de la combinaison de touches <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="paragraph">
<p>Nous en savons dÃ©sormais suffisamment pour <strong>tester dans les conditions des navigateurs web</strong> avec du <strong>code modulaire et rÃ©utilisable</strong>.</p>
</div>
<div class="paragraph">
<p>La question qui se pose dÃ©sormais est la suivante : <strong>comment faire pour tester plusieurs versions d&#8217;un mÃªme navigateur</strong>, pour tester sur un systÃ¨me d&#8217;exploitation que l&#8217;on n&#8217;a pas ou encore plusieurs <strong>terminaux mobiles</strong> de type <em>smartphone</em> ou tablette.</p>
</div>
</div>
<div class="sect2">
<h3 id="ci">7.5. IntÃ©gration continue et compatibilitÃ© navigateurs</h3>
<div class="paragraph">
<p>Plusieurs cas de figure se posent en complÃ©ment de la section prÃ©cÃ©dente :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la <strong>difficultÃ© d&#8217;accÃ¨s</strong> Ã  certaines combinaisons <em>navigateur web</em> + <em>systÃ¨me d&#8217;exploitation</em> ;</p>
</li>
<li>
<p>l&#8217;envie d'<strong>automatiser les tests</strong> de navigateurs web.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En Ã©tant sous <em>Windows</em>, il nous sera difficile de tester <em>Safari pour macOS</em>.
Inversement, en Ã©tant sous <em>macOS</em> il nous sera difficile de tester <em>Internet Explorer pour Windows XP</em> ou <em>Edge pour Windows 10</em>.
Que dire d&#8217;anciennes versions de navigateurs Android dont la rapiditÃ© de dÃ©veloppement et donc la compatibilitÃ© est bien en deÃ§Ã  des versions de Chrome pour ordinateur ou mobile.</p>
</div>
<div class="videoblock">
<div class="title">Exemple de tests multi-navigateurs en continu avec <em>karma</em> et <em>BrowserStack</em>.</div>
<div class="content">
<video src="./videos/karma-browserstack.mp4" width="70%" controls>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>L&#8217;Ã©cosystÃ¨me de modules <em>npm</em> liÃ©s Ã  <em>karma</em> s&#8217;est dÃ©jÃ  penchÃ© sur la question.
C&#8217;est le cas notamment du produit <em>BrowserStack</em> qui offre une intÃ©gration pour dÃ©lÃ©guer l&#8217;exÃ©cution des tests sur leur plate-forme commerciale.
Il s&#8217;agit du module <code>karma-browserstack-launcher</code> (<span class="URL"><a href="https://npmjs.com/karma-browserstack-launcher" class="bare">npmjs.com/karma-browserstack-launcher</a></span>).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>BrowserStack</em></div>
<div class="paragraph">
<p>La documentation de <em>BrowserStack</em> dÃ©crit les diffÃ©rents systÃ¨mes d&#8217;exploitation Ã  disposition ainsi que les navigateurs web compatibles, pour PC, Mac, iOS et Android.
L&#8217;intÃ©gration avec Node est Ã©galement documentÃ©e au cas oÃ¹ vous souhaiteriez effectuer des tests sans passer par <em>karma</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://www.browserstack.com/automate/node" class="bare">www.browserstack.com/automate/node</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://www.browserstack.com/list-of-browsers-and-platforms" class="bare">www.browserstack.com/list-of-browsers-and-platforms</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> n&#8217;est pas un navigateur en soi mais offre un accÃ¨s Ã  une multitude de navigateurs.
Il faut donc crÃ©er de nouvelles configurations de navigateurs dans la propriÃ©tÃ© de configuration <code>customLaunchers</code>.
L&#8217;extrait de configuration suivant illustre la crÃ©ation d&#8217;un navigateur <em>Safari</em> pour <em>iPhone 4S</em> sous <em>iOS 5.1</em> :</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L84-91</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">customLaunchers: {
  iphone4: {
    base: 'BrowserStack',
    device: 'iPhone 4S',
    os: 'ios',
    os_version: '5.1'
  },
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de <em>BrowserStack</em> nÃ©cessite un compte et l&#8217;obtention d&#8217;une clÃ© d&#8217;API afin d&#8217;utiliser leur service.
Notre <em>npm d&#8217;utilisateur</em> et la <em>clÃ© d&#8217;API</em> doivent Ãªtre renseignÃ©s en tant que <strong>variables d&#8217;environnement</strong> pour Ã©tablir une connexion au service et dÃ©marrer notre bon vieil iPhone 4 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>export BROWSER_STACK_USERNAME=â¦
<span data-bash-subs="$"></span>export BROWSER_STACK_ACCESS_KEY=â¦
<span data-bash-subs="$"></span>npm run test:browser -- --browsers iphone4</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>BrowserStack</em> peut Ãªtre configurÃ© plus finement selon vos besoins.
Le rÃ©glage suivant s&#8217;assure de faire transiter les donnÃ©es HTTP (scripts, HTML, etc.) via la connexion sÃ©curisÃ©e entre notre ordinateur et <em>BrowserStack</em>.
C&#8217;est un rÃ©glage utile en cas de <strong>proxy exigeant</strong> ou de <strong>rÃ©glages de connexion Ã  Internet</strong> bien spÃ©cifiques.</p>
</div>
<div class="listingblock">
<div class="title">karma.conf.js#L52-54</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">browserStack: {
  forcelocal: true,
},</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Alternative</span> <em>Sauce Labs</em></div>
<div class="paragraph">
<p><em>Sauce Labs</em> est un concurrent de <em>BrowserStack</em> et offre des fonctionnalitÃ©s similaires.
Il est gratuit pour les projets <em>open source</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://saucelabs.com" class="bare">saucelabs.com</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>IndÃ©pendamment de <em>BrowserStack</em>, l'<strong>intÃ©gration continue</strong> est un mÃ©canisme permettant l'<strong>exÃ©cution automatique</strong> des tests, de maniÃ¨re <strong>reproductible</strong> et dans un <strong>environnement systÃ©matiquement propre</strong> â sans trace d&#8217;exÃ©cution d&#8217;un prÃ©cÃ©dent test.</p>
</div>
<div class="paragraph">
<p>Cela a deux avantages indÃ©niables :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exÃ©cuter les <strong>tests pour tout changement de code</strong>, peu importe qui en est l&#8217;auteur ;</p>
</li>
<li>
<p>s&#8217;assurer de l'<strong>exÃ©cution systÃ©matique des tests</strong> ;</p>
</li>
<li>
<p><strong>mettre en commun</strong> la logique d&#8217;exÃ©cution de tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On Ã©vite ainsi les <em>oublis</em> tout en enlevant le coÃ»t de mise en place de l&#8217;infrastructure de tests chez des personnes contribuant de maniÃ¨re occasionnelle.
Cerise sur le gÃ¢teau, on prÃ©vient en partie les rÃ©gressions â changement qui casse le fonctionnement attendu d&#8217;une fonctionnalitÃ©.</p>
</div>
<div class="paragraph">
<p>Le service <em>Travis CI</em> (<span class="URL"><a href="https://travis-ci.org" class="bare">travis-ci.org</a></span>) est un service d&#8217;intÃ©gration continue (<em>Continuous Integration</em>, <em>CI</em>) parmi d&#8217;autres mais qui a Ã©tÃ© rendu populaire pour son intÃ©gration avec <em>GitHub</em>.
Il est gratuit pour les projets <em>open source</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Astuce</span> Installer le programme <code>travis</code></div>
<div class="paragraph">
<p>Le service <em>Travis CI</em> met Ã  disposition un programme en ligne de commande Ã©crit en Ruby.
Ce programme offre divers utilitaires comme le suivi des derniers jobs ainsi que la possibilitÃ© de crypter des secrets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><span data-bash-subs="$"></span>gem install travis --no-doc --no-ri
<span data-bash-subs="$"></span>travis login
<span data-bash-subs="$"></span>travis help</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un service d&#8217;intÃ©gration continue est configurÃ© pour dÃ©finir ce qui est exÃ©cutÃ© <em>avant</em>, <em>pendant</em> et <em>aprÃ¨s</em> les tests.
Il a donc l&#8217;avantage de faciliter l&#8217;automatisation des tests de navigateurs web Ã  mÃªme la <em>machine virtuelle</em> (<em>Virtual Machine</em>, <em>VM</em>) de test ou bien vers des plates-formes comme <em>BrowserStack</em>.
Son mÃ©canisme de <strong>variables d&#8217;environnement cryptÃ©es</strong> nous Ã©vitera de donner accÃ¨s Ã  notre compte au premier venu.</p>
</div>
<div class="paragraph">
<p>Un fichier de configuration minimal au format YAML est nÃ©cessaire.
Des services comme <em>GitHub</em> facilitent la connexion avec <em>Travis CI</em> et dÃ©clenchent automatiquement l&#8217;exÃ©cution des tests Ã  chaque commit ou <em>pull request</em>.</p>
</div>
<div class="listingblock">
<div class="title">.travis.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">sudo: false

language: node_js             # <1>
node_js: v8 # <2>

addons:
  firefox: latest       # <3>

script: xvfb-run npm run test:browser -- --browsers Firefox # <4>

env:
  BROWSER_STACK_USERNAME:
    - secure: â¦         # <5>
  BROWSER_STACK_ACCESS_KEY:
    - secure: â¦         # <5></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Configuration de la <em>VM</em> pour utiliser <em>Node</em> ;</p>
</li>
<li>
<p>Configuration de la <em>VM</em> pour utiliser la version la plus rÃ©cente de Node v8 ;</p>
</li>
<li>
<p>Installation de la derniÃ¨re version stable de <em>Firefox</em> ;</p>
</li>
<li>
<p><code>xvfb-run</code> est un programme Linux Ã©mulant le rendu d&#8217;une carte graphique vers un Ã©cran d&#8217;affichage â il nous aide Ã  lancer Firefox alors que nous n&#8217;avons pas d&#8217;Ã©cran ;</p>
</li>
<li>
<p>Les codes d&#8217;accÃ¨s Ã  <em>BrowserStack</em> sont cryptÃ©s Ã  l&#8217;aide du programme Ruby <code>travis</code> via la commande <code>travis encrypt</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">ð¡</div>
</td>
<td class="content">
<div class="title"><span class="RemarquePreTitre">Documentation</span> <em>Travis CI</em></div>
<div class="paragraph">
<p>Des services comme <em>Travis CI</em> sont puissants et amplement configurable pour de nombreux besoins, y compris la connexion Ã  des bases de donnÃ©es Postgres ou MariaDB.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/languages/javascript-with-nodejs/" class="bare">docs.travis-ci.com/user/languages/javascript-with-nodejs/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/" class="bare">docs.travis-ci.com/user/gui-and-headless-browsers/</a></span></p>
</li>
<li>
<p><span class="URL"><a href="https://docs.travis-ci.com/user/firefox/" class="bare">docs.travis-ci.com/user/firefox/</a></span></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion">8. Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nous sommes dÃ©sormais en mesure d'<strong>exÃ©cuter des tests unitaires</strong> impliquant des <strong>navigateurs web</strong> sur notre machine, sur des <strong>services distants</strong> mais Ã©galement de maniÃ¨re automatique avec des services d'<strong>intÃ©gration continue</strong> comme <em>Travis CI</em>.</p>
</div>
<div class="paragraph">
<p>Le recours aux modules <em>npm</em> combinÃ©s aux modules <em>ECMAScript</em> facilite le <strong>design et la maintenance de code testable et rÃ©utilisable</strong>.</p>
</div>
<div class="paragraph">
<p>Ces pratiques de modularisation â jusqu&#8217;au rendu intermÃ©diaire de <em>React</em> â encouragent une <strong>rigueur ayant un impact positif</strong> sur la qualitÃ© de notre code et notre confiance Ã  le dÃ©ployer en production.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
DerniÃ¨re mise Ã  jour 2018-03-06 20:18:41 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>